{
  "markdown": "\n\nSummary\n\nFrom mid-June through mid-July 2022, CISA conducted an incident response engagement at a Federal Civilian Executive Branch (FCEB) organization where CISA observed suspected advanced persistent threat (APT) activity. In the course of incident response activities, CISA determined that cyber threat actors exploited the Log4Shell vulnerability in an unpatched VMware Horizon server, installed XMRig crypto mining software, moved laterally to the domain controller (DC), compromised credentials, and then implanted Ngrok reverse proxies on several hosts to maintain persistence. CISA and the Federal Bureau of Investigation (FBI) assess that the FCEB network was compromised by Iranian government-sponsored APT actors.\nCISA and FBI are releasing this Cybersecurity Advisory (CSA) providing the suspected Iranian government-sponsored actors\u2019 tactics, techniques, and procedures (TTPs) and indicators of compromise (IOCs) to help network defenders detect and protect against related compromises.\nCISA and FBI encourage all organizations with affected VMware systems that did not immediately apply available patches or workarounds to assume compromise and initiate threat hunting activities. If suspected initial access or compromise is detected based on IOCs or TTPs described in this CSA, CISA and FBI encourage organizations to assume lateral movement by threat actors, investigate connected systems (including the DC), and audit privileged accounts. All organizations, regardless of identified evidence of compromise, should apply the recommendations in the Mitigations section of this CSA to protect against similar malicious cyber activity.\nFor more information on Iranian government-sponsored Iranian malicious cyber activity, see CISA\u2019s Iran Cyber Threat Overview and Advisories webpage and FBI\u2019s Iran Threats webpage.\nDownload the PDF version of this report: pdf, 528 kb.\nFor a downloadable copy of the Malware Analysis Report (MAR) accompanying this report, see: MAR 10387061-1.v1.\nFor a downloadable copy of IOCs, see: AA22-320A.stix, 1.55 mb.\n\nTechnical Details\n\nNote: This advisory uses the MITRE ATT&CK for Enterprise framework, version 11. See the MITRE ATT&CK Tactics and Techniques section for a table of the threat actors\u2019 activity mapped to MITRE ATT&CK\u00ae tactics and techniques with corresponding mitigation and/or detection recommendations.\nOverview\nIn April 2022, CISA conducted retrospective analysis using EINSTEIN\u2014an FCEB-wide intrusion detection system (IDS) operated and monitored by CISA\u2014and identified suspected APT activity on an FCEB organization\u2019s network. CISA observed bi-directional traffic between the network and a known malicious IP address associated with exploitation of the Log4Shell vulnerability (CVE-2021-44228)\u00a0in VMware Horizon servers. In coordination with the FCEB organization, CISA initiated threat hunting incident response activities; however, prior to deploying an incident response team, CISA observed additional suspected APT activity. Specifically, CISA observed HTTPS activity from IP address 51.89.181[.]64 to the organization\u2019s VMware server. Based on trusted third-party reporting, 51.89.181[.]64 is a Lightweight Directory Access Protocol (LDAP) server associated with threat actors exploiting Log4Shell. Following HTTPS activity, CISA observed a suspected LDAP callback on port 443 to this IP address. CISA also observed a DNS query for us\u2010nation\u2010ny[.]cf that resolved back to 51.89.181[.]64 when the victim server was returning this Log4Shell LDAP callback to the actors\u2019 server.\nCISA assessed that this traffic indicated a confirmed compromise based on the successful callback to the indicator and informed the organization of these findings; the organization investigated the activity and found signs of compromise. As trusted-third party reporting associated Log4Shell activity from 51.89.181[.]64 with lateral movement and targeting of DCs, CISA suspected the threat actors had moved laterally and compromised the organization\u2019s DC.\nFrom mid-June through mid-July 2022, CISA conducted an onsite incident response engagement and determined that the organization was compromised as early as February 2022, by likely Iranian government-sponsored APT actors who installed XMRig crypto mining software. The threat actors also moved laterally to the domain controller, compromised credentials, and implanted Ngrok reverse proxies.\nThreat Actor Activity\nIn February 2022, the threat actors exploited Log4Shell [T1190] for initial access [TA0001] to the organization\u2019s unpatched VMware Horizon server. As part of their initial exploitation, CISA observed a connection to known malicious IP address 182.54.217[.]2 lasting 17.6 seconds.\nThe actors\u2019 exploit payload ran the following PowerShell command [T1059.001] that added an exclusion rule to Windows Defender [T1562.001]:\npowershell try{Add-MpPreference -ExclusionPath 'C:\\'; Write-Host 'added-exclusion'} catch {Write-Host 'adding-exclusion-failed' }; powershell -enc \"$BASE64 encoded payload to download next stage and execute it\"\nThe exclusion rule allowlisted the entire c:\\drive, enabling threat actors to download tools to the c:\\drive without virus scans. The exploit payload then downloaded mdeploy.text from 182.54.217[.]2/mdepoy.txt to C:\\users\\public\\mde.ps1 [T1105]. When executed, mde.ps1 downloaded file.zip from 182.54.217[.]2 and removed mde.ps1 from the disk [T1070.004].\nfile.zip contained XMRig cryptocurrency mining software and associated configuration files.\n\nWinRing0x64.sys \u2013 XMRig Miner driver\nwuacltservice.exe \u2013 XMRig Miner\nconfig.json \u2013 XMRig miner configuration\nRuntimeBroker.exe \u2013 Associated file. This file can create a local user account [T1136.001] and tests for internet connectivity by pinging 8.8.8.8 [T1016.001]. The exploit payload created a Scheduled Task [T1053.005] that executed RuntimeBroker.exe daily as SYSTEM. Note: By exploiting Log4Shell, the actors gained access to a VMware service account with administrator and system level access. The Scheduled Task was named RuntimeBrokerService.exe to masquerade as a legitimate Windows task.\n\nSee MAR 10387061-1.v1 for additional information, including IOCs, on these four files.\nAfter obtaining initial access and installing XMRig on the VMWare Horizon server, the actors used RDP [T1021.001] and the built-in Windows user account DefaultAccount [T1078.001] to move laterally [TA0008] to a VMware VDI-KMS host. Once the threat actor established themselves on the VDI-KMS host, CISA observed the actors download around 30 megabytes of files from transfer[.]sh server associated with 144.76.136[.]153. The actors downloaded the following tools:\n\nPsExec \u2013 a Microsoft signed tool for system administrators.\nMimikatz \u2013 a credential theft tool.\nNgrok \u2013 a reverse proxy tool for proxying an internal service out onto an Ngrok domain, which the user can then access at a randomly generated subdomain at *.ngrok[.]io. CISA has observed this tool in use by some commercial products for benign purposes; however, this process bypasses typical firewall controls and may be a potentially unwanted application in production environments. Ngrok is known to be used for malicious purposes.[1]\n\nThe threat actors then executed Mimikatz on VDI-KMS to harvest credentials and created a rogue domain administrator account [T1136.002]. Using the newly created account, the actors leveraged RDP to propagate to several hosts within the network. Upon logging into each host, the actors manually disabled Windows Defender via the Graphical User Interface (GUI) and implanted Ngrok executables and configuration files. The threat actors were able to implant Ngrok on multiple hosts to ensure Ngrok\u2019s persistence should they lose access to a machine during a routine reboot. The actors were able to proxy [T1090] RDP sessions, which were only observable on the local network as outgoing HTTPS port 443 connections to tunnel.us.ngrok[.]com and korgn.su.lennut[.]com (the prior domain in reverse). It is possible, but was not observed, that the threat actors configured a custom domain, or used other Ngrok tunnel domains, wildcarded here as *.ngrok[.]com, *.ngrok[.]io, ngrok.*.tunnel[.]com, or korgn.*.lennut[.]com.\nOnce the threat actors established a deep foothold in the network and moved laterally to the domain controller, they executed the following PowerShell command on the Active Directory to obtain a list of all machines attached to the domain [T1018]:\nPowershell.exe get-adcomputer -filter * -properties * | select name,operatingsystem,ipv4address &gt;\nThe threat actors also changed the password for the local administrator account [T1098] on several hosts as a backup should the rogue domain administrator account get detected and terminated. Additionally, the threat actor was observed attempting to dump the Local Security Authority Subsystem Service (LSASS) process [T1003.001] with task manager but this was stopped by additional anti-virus the FCEB organization had installed.\nMITRE ATT&CK TACTICS AND TECHNIQUES\nSee table 1 for all referenced threat actor tactics and techniques in this advisory, as well as corresponding detection and/or mitigation recommendations. For additional mitigations, see the Mitigations section.\n\nTable 1: Cyber Threat Actors ATT&CK Techniques for Enterprise\n\n\n\nInitial Access\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nExploit Public-Facing Application\n\n\nT1190\n\n\nThe actors exploited Log4Shell for initial access to the organization\u2019s VMware Horizon server.\n\n\nMitigation/Detection: Use a firewall or web-application firewall and enable logging to prevent and detect potential Log4Shell exploitation attempts [M1050].\nMitigation: Perform regular vulnerability scanning to detect Log4J vulnerabilities and update Log4J software using vendor provided patches [M1016],[M1051].\n\n\n\n\nExecution\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendation\n\n\n\n\nCommand and Scripting Interpreter: PowerShell\n\n\nT1059.001\n\n\nThe actors ran PowerShell commands that added an exclusion rule to Windows Defender.\nThe actors executed PowerShell on the AD to obtain a list of machines on the domain.\n\n\nMitigation: Disable or remove PowerShell for non-administrative users [M1042],[M1026] or enable code-signing to execute only signed scripts [M1045].\nMitigation: Employ anti-malware to automatically detect and quarantine malicious scripts [M1049].\n\n\n\n\nPersistence\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nAccount Manipulation\n\n\nT1098\n\n\nThe actors changed the password for the local administrator account on several hosts.\n\n\nMitigation: Use multifactor authentication for user and privileged accounts [M1032].\nDetection: Monitor events for changes to account objects and/or permissions on systems and the domain, such as event IDs 4738, 4728, and 4670. Monitor for modification of accounts in correlation with other suspicious activity [DS0002].\n\n\n\n\nCreate Account: Local Account\n\n\nT1136.001\n\n\nThe actors\u2019 malware can create local user accounts.\n\n\nMitigation: Configure access controls and firewalls to limit access to domain controllers and systems used to create and manage accounts.\nDetection: Monitor executed commands and arguments for actions that are associated with local account creation, such as net user /add , useradd, and dscl -create [DS0017].\nDetection: Enable logging for new user creation [DS0002].\n\n\n\n\nCreate Account: Domain Account\n\n\nT1136.002\n\n\nThe actors used Mimikatz to create a rogue domain administrator account.\n\n\nMitigation: Configure access controls and firewalls to limit access to domain controllers and systems used to create and manage accounts.\nDetection: Enable logging for new user creation, especially domain administrator accounts [DS0002].\n\n\n\n\nScheduled Task/Job: Scheduled Task\n\n\nT1053.005\n\n\nThe actors\u2019 exploit payload created Scheduled Task RuntimeBrokerService.exe, which executed RuntimeBroker.exe daily as SYSTEM.\n\n\nMitigation: Configure settings for scheduled tasks to force tasks to run under the context of the authenticated account instead of allowing them to run as SYSTEM [M1028].\nDetection: Monitor for newly constructed processes and/or command-lines that execute from the svchost.exe in Windows 10 and the Windows Task Scheduler taskeng.exe for older versions of Windows [DS0009]\nDetection: Monitor for newly constructed scheduled jobs by enabling the Microsoft-Windows-TaskScheduler/Operational setting within the event logging service [DS0003].\n\n\n\n\nValid Accounts: Default Accounts\n\n\nT1078.001\n\n\nThe actors used built-in Windows user account DefaultAccount.\n\n\nMitigation: Change default usernames and passwords immediately after the installation and before deployment to a production environment [M1027].\nDetection: Develop rules to monitor logon behavior across default accounts that have been activated or logged into [DS0028].\n\n\n\n\nDefense Evasion\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nImpair Defenses: Disable or Modify Tools\n\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 \n\n\nT1562.001\n\n\nThe actors added an exclusion rule to Windows Defender. The tool allowlisted the entire c:\\drive, enabling the actors to bypass virus scans for tools they downloaded to the c:\\drive.\nThe actors manually disabled Windows Defender via the GUI.\n\n\nMitigation: Ensure proper user permissions are in place to prevent adversaries from disabling or interfering with security services. [M1018].\nDetection: Monitor for changes made to Windows Registry keys and/or values related to services and startup programs that correspond to security tools such as HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows Defender [DS0024].\nDetection: Monitor for telemetry that provides context for modification or deletion of information related to security software processes or services such as Windows Defender definition files in Windows and System log files in Linux [DS0013].\nDetection: Monitor processes for unexpected termination related to security tools/services [DS0009].\n\n\n\n\nIndicator Removal on Host: File Deletion\n\n\nT1070.004\n\n\nThe actors removed malicious file mde.ps1 from the dis. \n\n\nDetection: Monitor executed commands and arguments for actions that could be utilized to unlink, rename, or delete files [DS0017].\nDetection: Monitor for unexpected deletion of files from the system [DS0022].\n\n\n\n\nCredential Access\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nOS Credential Dumping: LSASS Memory\n\n\nT1003.001\n\n\nThe actors were observed trying to dump LSASS process.\n\n\nMitigation: With Windows 10, Microsoft implemented new protections called Credential Guard to protect the LSA secrets that can be used to obtain credentials through forms of credential dumping [M1043]\nMitigation: On Windows 10, enable Attack Surface Reduction (ASR) rules to secure LSASS and prevent credential stealing [M1040].\nMitigation: Ensure that local administrator accounts have complex, unique passwords across all systems on the network [M1027].\nDetection: Monitor for unexpected processes interacting with LSASS.exe.\u00a0Common credential dumpers such as Mimikatz access LSASS.exe by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details are stored. [DS0009].\nDetection: Monitor executed commands and arguments that may attempt to access credential material stored in the process memory of the LSASS [DS0017].\n\n\n\n\nCredentials from Password Stores\n\n\nT1555\n\n\nThe actors used Mimikatz to harvest credentials.\n\n\nMitigation: Organizations may consider weighing the risk of storing credentials in password stores and web browsers. If system, software, or web browser credential disclosure is a significant concern, technical controls, policy, and user training may be used to prevent storage of credentials in improper locations [M1027].\nDetection: Monitor for processes being accessed that may search for common password storage locations to obtain user credentials [DS0009].\nDetection: Monitor executed commands and arguments that may search for common password storage locations to obtain user credentials [DS0017].\n\n\n\n\nDiscovery\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nRemote System Discovery\n\n\nT1018\n\n\nThe actors executed a PowerShell command on the AD to obtain a list of all machines attached to the domain.\n\n\nDetection: Monitor executed commands and arguments that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for lateral movement [DS0017].\nDetection: Monitor for newly constructed network connections associated with pings/scans that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for lateral movement [DS0029].\nDetection: Monitor for newly executed processes that can be used to discover remote systems, such as ping.exe and tracert.exe, especially when executed in quick succession [DS0009].\n\n\n\n\nSystem Network Configuration Discovery: Internet Connection Discovery\n\n\nT1016.001\n\n\nThe actors\u2019 malware tests for internet connectivity by pinging 8.8.8.8.\n\n\nMitigation: Monitor executed commands, arguments [DS0017] and executed processes (e.g., tracert or ping) [DS0009] that may check for internet connectivity on compromised systems. \n\n\n\n\nLateral Movement\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nRemote Services: Remote Desktop Protocol\n\n\nT1021.001\n\n\nThe actors used RDP to move laterally to multiple hosts on the network.\n\n\nMitigation: Use MFA for remote logins [M1032].\nMitigation: Disable the RDP service if it is unnecessary [M1042].\nMitigation: Do not leave RDP accessible from the internet. Enable firewall rules to block RDP traffic between network security zones within a network [M1030].\nMitigation: Consider removing the local Administrators group from the list of groups allowed to log in through RDP [M1026].\nDetection: Monitor for user accounts logged into systems associated with RDP (ex: Windows EID 4624 Logon Type 10). Other factors, such as access patterns (ex: multiple systems over a relatively short period of time) and activity that occurs after a remote login, may indicate suspicious or malicious behavior with RDP [DS0028].\n\n\n\n\nCommand and Control\n\n\n\n\nTechnique Title\n\n\nID\n\n\nUse\n\n\nRecommendations\n\n\n\n\nProxy\n\n\nT1090\n\n\nThe actors used Ngrok to proxy RDP connections and to perform command and control.\n\n\nMitigation: Traffic to known anonymity networks and C2 infrastructure can be blocked through the use of network allow and block lists [M1037].\nDetection: Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure) [DS0029].\n\n\n\n\nIngress Tool Transfer\n\n\nT1105\n\n\nThe actors downloaded malware and multiple tools to the network, including PsExec, Mimikatz, and Ngrok.\n\n\nMitigation: Employ anti-malware to automatically detect and quarantine malicious scripts [M1049].\n\u00a0\n\n\n\n\n\u00a0\nINCIDENT RESPONSE\nIf suspected initial access or compromise is detected based on IOCs or TTPs in this CSA, CISA encourages organizations to assume lateral movement by threat actors and investigate connected systems and the DC.\nCISA recommends organizations apply the following steps before applying any mitigations, including patching.\n\nImmediately isolate affected systems.\nCollect and review relevant logs, data, and artifacts. Take a memory capture of the device(s) and a forensic image capture for detailed analysis.\nConsider soliciting support from a third-party incident response organization that can provide subject matter expertise to ensure the actor is eradicated from the network and to avoid residual issues that could enable follow-on exploitation.\nReport incidents to CISA via CISA\u2019s 24/7 Operations Center (report@cisa.gov or 888-282-0870) or your local FBI field office, or FBI\u2019s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by e-mail at CyWatch@fbi.gov.\n\t\u00a0\n\n\nMitigations\n\nCISA and FBI recommend implementing the mitigations below and in Table 1 to improve your organization's cybersecurity posture on the basis of threat actor behaviors.\n\nInstall updated builds to ensure affected VMware Horizon and UAG systems are updated to the latest version.\n\nIf updates or workarounds were not promptly applied following VMware\u2019s release of updates for Log4Shell in December 2021, treat those VMware Horizon systems as compromised. Follow the pro-active incident response procedures outlined above prior to applying updates. If no compromise is detected, apply these updates as soon as possible.\n\nSee VMware Security Advisory VMSA-2021-0028.13 and VMware Knowledge Base (KB) 87073 to determine which VMware Horizon components are vulnerable.\nNote: Until the update is fully implemented, consider removing vulnerable components from the internet to limit the scope of traffic. While installing the updates, ensure network perimeter access controls are as restrictive as possible.\nIf upgrading is not immediately feasible, see KB87073 and KB87092 for vendor-provided temporary workarounds. Implement temporary solutions using an account with administrative privileges. Note that these temporary solutions should not be treated as permanent fixes; vulnerable components should be upgraded to the latest build as soon as possible.\nPrior to implementing any temporary solution, ensure appropriate backups have been completed.\nVerify successful implementation of mitigations by executing the vendor supplied script Horizon_Windows_Log4j_Mitigations.zip without parameters to ensure that no vulnerabilities remain. See KB87073 for details.\n\n\n\n\nKeep all software up to date and prioritize patching known exploited vulnerabilities (KEVs).\nMinimize the internet-facing attack surface by hosting essential services on a segregated DMZ, ensuring strict network perimeter access controls, and not hosting internet-facing services that are not essential to business operations. Where possible, implement regularly updated web application firewalls (WAF) in front of public-facing services. WAFs can protect against web-based exploitation using signatures and heuristics that are likely to block or alert on malicious traffic.\nUse best practices for identity and access management (IAM) by implementing phishing resistant multifactor authentication (MFA), enforcing use of strong passwords, regularly auditing administrator accounts and permissions, and limiting user access through the principle of least privilege. Disable inactive accounts uniformly across the AD, MFA systems, etc.\n\nIf using Windows 10 version 1607 or Windows Server 2016 or later, monitor or disable Windows DefaultAccount, also known as the Default System Managed Account (DSMA).\n\n\nAudit domain controllers to log successful Kerberos Ticket Granting Service (TGS) requests and ensure the events are monitored for anomalous activity. \u00a0\n\nSecure accounts.\nEnforce the principle of least privilege. Administrator accounts should have the minimum permission necessary to complete their tasks.\nEnsure there are unique and distinct administrative accounts for each set of administrative tasks.\nCreate non-privileged accounts for privileged users and ensure they use the non-privileged accounts for all non-privileged access (e.g., web browsing, email access).\n\n\nCreate a deny list of known compromised credentials and prevent users from using known-compromised passwords.\nSecure credentials by restricting where accounts and credentials can be used and by using local device credential protection features.\u00a0\n\nUse virtualizing solutions on modern hardware and software to ensure credentials are securely stored.\nEnsure storage of clear text passwords in LSASS memory is disabled. Note: For Windows 8, this is enabled by default. For more information see Microsoft Security Advisory Update to Improve Credentials Protection and Management.\nConsider disabling or limiting NTLM and WDigest Authentication.\nImplement Credential Guard for Windows 10 and Server 2016 (refer to Microsoft: Manage Windows Defender Credential Guard for more information). For Windows Server 2012R2, enable Protected Process Light for Local Security Authority (LSA).\nMinimize the AD attack surface to reduce malicious ticket-granting activity. Malicious activity such as \u201cKerberoasting\u201d takes advantage of Kerberos\u2019 TGS and can be used to obtain hashed credentials that threat actors attempt to crack.\n\t\t\u00a0\n\n\n\nVALIDATE SECURITY CONTROLS\nIn addition to applying mitigations, CISA and FBI recommend exercising, testing, and validating your organization's security program against the threat behaviors mapped to the MITRE ATT&CK for Enterprise framework in this advisory. CISA and FBI recommend testing your existing security controls inventory to assess how they perform against the ATT&CK techniques described in this advisory.\nTo get started:\n\nSelect an ATT&CK technique described in this advisory (see table 1).\nAlign your security technologies against the technique.\nTest your technologies against the technique.\nAnalyze your detection and prevention technologies performance.\nRepeat the process for all security technologies to obtain a set of comprehensive performance data.\nTune your security program, including people, processes, and technologies, based on the data generated by this process.\n\nCISA and FBI recommend continually testing your security program, at scale, in a production environment to ensure optimal performance against the MITRE ATT&CK techniques identified in this advisory.\n\nReferences\n\n[1] MITRE ATT&CK Version 11: Software \u2013 Ngrok\n\nRevisions\n\nInitial Version: November 16, 2022\n",
  "cves": [
    "CVE-2021-44228"
  ],
  "techniques": [
    "T1059.001",
    "T1053.005",
    "T1562.001",
    "T1070.004",
    "T1021.001",
    "T1003.001",
    "T1136.001",
    "T1078.001",
    "T1136.002",
    "T1016.001"
  ],
  "advisory": "aa22-320a",
  "title": "Iranian Government-Sponsored APT Actors Compromise Federal Network, Deploy Crypto Miner, Credential Harvester | CISA",
  "source": "cybersecurity-advisories",
  "id": "fe04b9cf4ec2cc8476521c8d627495c9534c3b670c46dbbcf48f2fddbcb159e7"
}