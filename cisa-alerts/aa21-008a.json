{"markdown": "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Detecting Post\\-Compromise Threat Activity in Microsoft Cloud Environments \\| CISA\n \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n[Skip to main content](#main) \n\n\n\n\n\n\n\n\n\n\n\n\n![U.S. flag](/profiles/cisad8_gov/themes/custom/gesso/dist/images/us_flag_small.png)\n\n\n\n An official website of the United States government\n \n\n\n\n Here\u2019s how you know\n \n\n\n\n\n\n Here\u2019s how you know\n \n\n\n\n\n\n\n![Dot gov](/profiles/cisad8_gov/themes/custom/gesso/dist/images/icon-dot-gov.svg)\n\n\n**Official websites use .gov** \n  \n\n A\n **.gov** \n website belongs to an official government organization in the United States.\n \n\n\n\n\n\n![HTTPS](/profiles/cisad8_gov/themes/custom/gesso/dist/images/icon-https.svg)\n\n\n**Secure .gov websites use HTTPS** \n  \n\n A\n **lock** \n (\n \n\n\n Lock\n \n\n A locked padlock\n \n\n\n\n\n ) or\n **https://** \n means you\u2019ve safely connected to the .gov website. Share sensitive information only on official, secure websites.\n \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n[Free Cyber Services](/resources-tools/resources/free-cybersecurity-services-and-tools \"Free Cyber Services\") \n[\\#protect2024](/protect2024) \n[Secure Our World](/node/18883) \n[Shields Up](/node/8056) \n[Report A Cyber Issue](/node/16591) \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n[![CISA Logo Americas Cyber Defense Agency](/sites/default/files/images/SVG/header_logo_tagline_update.svg)](/)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n[![CISA Logo](/sites/default/files/images/SVG/mobile_logo_wordmark.svg)](/)\n\n\n\n\n\n\n\n\n\n\n Search\n \n\n\n\n\n\n\n\n\n\n Menu\n \n\n\n\n\n\n\n\n\n\n\n\n\n![America's Cyber Defense Agency](/sites/default/files/images/SVG/header_tagline_mobile_update.svg)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Close\n \n\n\n\n\n* Topics\n \n\n\n\n[Topics](/topics) \n\n\n\n\n[Cybersecurity Best Practices](/topics/cybersecurity-best-practices)\n\n\n\n\n[Cyber Threats and Advisories](/topics/cyber-threats-and-advisories)\n\n\n\n\n[Critical Infrastructure Security and Resilience](/topics/critical-infrastructure-security-and-resilience)\n\n\n\n\n[Election Security](/topics/election-security)\n\n\n\n\n[Emergency Communications](/topics/emergency-communications)\n\n\n\n\n[Industrial Control Systems](/topics/industrial-control-systems)\n\n\n\n\n[Information and Communications Technology Supply Chain Security](/topics/information-communications-technology-supply-chain-security)\n\n\n\n\n[Partnerships and Collaboration](/topics/partnerships-and-collaboration)\n\n\n\n\n[Physical Security](/topics/physical-security)\n\n\n\n\n[Risk Management](/topics/risk-management)\n\n\n\n\n\n[How can we help?](/audiences) \n\n\n[Government](/topics/government) \n[Educational Institutions](/topics/educational-institutions) \n[Industry](/topics/industry) \n[State, Local, Tribal, and Territorial](/topics/state-local-tribal-and-territorial) \n[Individuals and Families](/topics/individuals-and-families) \n[Small and Medium Businesses](/topics/small-and-medium-businesses) \n[Find Help Locally](/audiences/find-help-locally) \n[Faith\\-Based Community](/audiences/faith-based-community) \n[Executives](/audiences/executives) \n[High\\-Risk Communities](/audiences/high-risk-communities)\n* [Spotlight](/spotlight)\n* Resources \\& Tools\n \n\n\n\n[Resources \\& Tools](/resources-tools) \n\n\n\n\n[All Resources \\& Tools](/resources-tools/all-resources-tools)\n\n\n\n\n[Services](/resources-tools/services)\n\n\n\n\n[Programs](/resources-tools/programs)\n\n\n\n\n[Resources](/resources-tools/resources)\n\n\n\n\n[Training](/resources-tools/training)\n\n\n\n\n[Groups](/resources-tools/groups)\n* News \\& Events\n \n\n\n\n[News \\& Events](/news-events) \n\n\n\n\n[News](/news-events/news)\n\n\n\n\n[Events](/news-events/events)\n\n\n\n\n[Cybersecurity Alerts \\& Advisories](/news-events/cybersecurity-advisories)\n\n\n\n\n[Directives](/news-events/directives)\n\n\n\n\n[Request a CISA Speaker](/news-events/request-speaker)\n\n\n\n\n[Congressional Testimony](/news-events/congressional-testimony)\n\n\n\n\n[CISA Conferences](/cisa-conferences)\n\n\n\n\n[CISA Live!](/cisa-live)\n* Careers\n \n\n\n\n[Careers](/careers) \n\n\n\n\n[Benefits \\& Perks](/careers/benefits-perks)\n\n\n\n\n[HireVue Applicant Reasonable Accommodations Process](/careers/hirevue-applicant-reasonable-accommodations-process)\n\n\n\n\n[Hiring](/general-recruitment-and-hiring-faqs)\n\n\n\n\n[Resume \\& Application Tips](/careers/resume-application-tips)\n\n\n\n\n[Students \\& Recent Graduates](/students-recent-graduates-employment-opportunities)\n\n\n\n\n[Veteran and Military Spouses](/careers/veteran-and-military-spouse-employment-opportunities)\n\n\n\n\n[Work @ CISA](/careers/work-cisa)\n* About\n \n\n\n\n[About](/about) \n\n\n\n\n[Culture](/about/culture)\n\n\n\n\n[Divisions \\& Offices](/about/divisions-offices)\n\n\n\n\n[Regions](/about/regions)\n\n\n\n\n[Leadership](/about/leadership)\n\n\n\n\n[Doing Business with CISA](/doing-business-cisa)\n\n\n\n\n[Site Links](/site-links)\n\n\n\n\n[Reporting Employee and Contractor Misconduct](/reporting-employee-and-contractor-misconduct)\n\n\n\n\n[CISA GitHub](/cisa-github)\n\n\n\n\n[CISA Central](/cisa-central)\n\n\n\n\n[2023 Year In Review](/about/2023YIR)\n\n\n\n\n[Contact Us](/about/contact-us)\n\n\n\n\n\n\n\n\n\n[Free Cyber Services](/resources-tools/resources/free-cybersecurity-services-and-tools \"Free Cyber Services\") \n[\\#protect2024](/protect2024) \n[Secure Our World](/node/18883) \n[Shields Up](/node/8056) \n[Report A Cyber Issue](/node/16591) \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Breadcrumb\n \n1. [Home](/)\n2. [News \\& Events](/news-events)\n3. [Cybersecurity Advisories](/news-events/cybersecurity-advisories)\n4. [Cybersecurity Advisory](/news-events/cybersecurity-advisories?f%5B0%5D=advisory_type%3A94)\n\n\n\n\n\n\n\n\n Share:\n \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n Cybersecurity Advisory\n \nDetecting Post\\-Compromise Threat Activity in Microsoft Cloud Environments\n==========================================================================\n\n\n\n\n\n Last Revised\n \n\n\n April 15, 2021\n \n\n\n\n\n Alert Code\n \n\n AA21\\-008A\n \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n### Summary\n\n\n\n\n*This Advisory uses the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT\\&CK\u00ae) framework. See the\n [ATT\\&CK for Enterprise](https://attack.mitre.org/versions/v7/techniques/enterprise/) \n for all referenced threat actor tactics and techniques.* \n\n\n\n\n***Updated April 15, 2021: The U.S. Government attributes this activity to the Russian Foreign Intelligence Service (SVR). Additional information may be found in a\n [statement from the White House](https://www.whitehouse.gov/briefing-room/statements-releases/2021/04/15/fact-sheet-imposing-costs-for-harmful-foreign-activities-by-the-russian-government/) \n . For more information on SolarWinds\\-related activity, go to\n [https://us\\-cert.cisa.gov/remediating\\-apt\\-compromised\\-networks](https://us-cert.cisa.gov/remediating-apt-compromised-networks) \n and\n [https://www.cisa.gov/supply\\-chain\\-compromise](https://www.cisa.gov/supply-chain-compromise) \n .***\n\n\n\n\n This Alert is a companion alert to\n [AA20\\-352A: Advanced Persistent Threat Compromise of Government Agencies, Critical Infrastructure, and Private Sector Organizations](https://us-cert.cisa.gov/ncas/alerts/aa20-352a) \n . AA20\\-352A primarily focuses on an advanced persistent threat (APT) actor\u2019s compromise of SolarWinds Orion products as an initial access vector into networks of U.S. Government agencies, critical infrastructure entities, and private network organizations. As noted in AA20\\-352A, the Cybersecurity and Infrastructure Security Agency (CISA) has evidence of initial access vectors in addition to the compromised SolarWinds Orion products.\n \n\n\n\n This Alert also addresses activity\u2014irrespective of the initial access vector leveraged\u2014that CISA attributes to an APT actor. Specifically, CISA has seen an APT actor using compromised applications in a victim\u2019s Microsoft 365 (M365\\)/Azure environment. CISA has also seen this APT actor utilizing additional credentials and Application Programming Interface (API) access to cloud resources of private and public sector organizations. These tactics, techniques, and procedures (TTPs) feature three key components:\n \n\n\n* Compromising or bypassing federated identity solutions;\n* Using forged authentication tokens to move laterally to Microsoft cloud environments; and\n* Using privileged access to a victim\u2019s cloud environment to establish difficult\\-to\\-detect persistence mechanisms for Application Programming Interface (API)\\-based access.\n\n\n\n This Alert describes these TTPs and offers an overview of, and guidance on, available open\\-source tools\u2014including a CISA\\-developed tool, Sparrow\u2014for network defenders to analyze their Microsoft Azure Active Directory (AD), Office 365 (O365\\), and M365 environments to detect potentially malicious activity.\n \n\n\n\n**Note** \n : this Alert describes artifacts\u2014presented by these attacks\u2014from which CISA has identified detectable evidence of the threat actor\u2019s initial objectives. CISA continues to analyze the threat actor\u2019s follow\\-on objectives.\n \n\n\n\n### Technical Details\n\n\n\n\n Frequently, CISA has observed the APT actor gaining\n *Initial Access* \n \\[\n [TA0001](https://attack.mitre.org/versions/v8/tactics/TA0001/) \n ] to victims\u2019 enterprise networks via compromised SolarWinds Orion products (e.g., Solorigate, Sunburst).\n [\\[1]](https://www.zdnet.com/article/a-second-hacking-group-has-targeted-solarwinds-systems/ ) \n However, CISA is investigating instances in which the threat actor may have obtained initial access by\n *Password Guessing* \n \\[\n [T1110\\.001](https://attack.mitre.org/versions/v8/techniques/T1110/001/) \n ],\n *Password Spraying* \n \\[\n [T1110\\.003](https://attack.mitre.org/versions/v8/techniques/T1110/003) \n ], and/or exploiting inappropriately secured administrative or service credentials (\n *Unsecured Credentials* \n \\[\n [T1552](https://attack.mitre.org/versions/v8/techniques/T1552/) \n ]) instead of utilizing the compromised SolarWinds Orion products.\n \n\n\n\n CISA observed this threat actor moving from user context to administrator rights for\n *Privilege Escalation* \n \\[\n [TA0004](https://attack.mitre.org/versions/v8/tactics/TA0004/) \n ] within a compromised network and using native Windows tools and techniques, such as Windows Management Instrumentation (WMI), to enumerate the Microsoft Active Directory Federated Services (ADFS) certificate\\-signing capability. This enumeration allows threat actors to forge authentication tokens (OAuth) to issue claims to service providers\u2014without having those claims checked against the identity provider\u2014and then to move laterally to Microsoft Cloud environments (\n *Lateral Movement* \n \\[\n [TA0008](https://attack.mitre.org/versions/v8/tactics/TA0008/) \n ]).\n \n\n\n\n The threat actor has also used on\\-premises access to manipulate and bypass identity controls and multi\\-factor authentication. This activity demonstrates how sophisticated adversaries can use credentials from one portion of an organization to move laterally (\n *Lateral Movement* \n \\[\n [TA0008](https://attack.mitre.org/versions/v8/tactics/TA0008/) \n ]) through trust boundaries, evade defenses and detection (\n *Defense Evasion* \n \\[\n [TA0005](https://attack.mitre.org/versions/v8/tactics/TA0005/) \n ]), and steal sensitive data (\n *Collection* \n \\[\n [TA0009](https://attack.mitre.org/versions/v8/tactics/TA0009/) \n ]).\n \n\n\n\n This level of compromise is challenging to remediate and requires a rigorous multi\\-disciplinary effort to regain administrative control before recovering.\n \n\n\n\n### Mitigations\n\n\n\n#### Detection\n\n\n\n Guidance on identifying affected SolarWinds software is well documented.\\[\n [2](https://www.cisa.gov/supply-chain-compromise ) \n ] However\u2014once an organization identifies a compromise via SolarWinds Orion products or other threat actor TTPs\u2014identifying follow\\-on activity for on\\-premises networks requires fine\\-tuned network and host\\-based forensics.\n \n\n\n\n The nature of cloud forensics is unique due to the growing and rapidly evolving technology footprints of major vendors. Microsoft's O365 and M365 environments have built\\-in capabilities for detecting unusual activity. Microsoft also provides premium services (Advanced Threat Protection \\[ATP] and Azure Sentinel), which enable network defenders to investigate TTPs specific to the Solorigate activity.\n [\\[3]](https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095 ) \n\n\n\n#### Detection Tools\n\n\n\n*CISA is providing examples of detection tools for informational purposes only. CISA does not endorse any commercial product or service, including any subjects of analysis. Any reference to specific commercial products, processes, or services does not constitute or imply their endorsement, recommendation, or favoring by CISA.* \n\n\n\n\n There are a number of open\\-source tools available to investigate adversary activity in Microsoft cloud environments and to detect unusual activity, service principals, and application activity.\n [\\[4]](https://msrc-blog.microsoft.com/2020/12/21/december-21st-2020-solorigate-resource-center/ ) \n Publicly available PowerShell tools that network defenders can use to investigate M365 and Microsoft Azure include:\n \n\n\n* CISA's Sparrow,\n* Open\\-source utility Hawk, and\n* CrowdStrike's Azure Reporting Tool (CRT).\n\n\n\n Additionally, Microsoft's Office 365 Management API and Graph API provide an open interface for ingesting telemetry and evaluating service configurations for signs of anomalous activity and intrusion.\n \n\n\n\n**Note** \n : these open\\-source tools are highlighted and explained to assist with on\\-site investigation and remediation in cloud environments but are not all\\-encompassing. Open source tools can be complemented by services such as Azure Sentinel, a Microsoft premium service that provides comprehensive analysis tools, including custom detections for the activity indicated.\n \n\n\n#### General Guidance on Using Detection Tools\n\n\n1. Audit the creation and use of service principal credentials. Look for unusual application usage, such as use of dormant applications.\n2. Audit the assignment of credentials to applications that allow non\\-interactive sign\\-in by the application. Look for unexpected trust relationships added to the Azure Active Directory.\n3. Download the interactive sign\\-ins from the Azure admin portal or use the Microsoft Sentinel product. Review new token validation time periods with high values and investigate whether it was a legitimate change or an attempt to gain persistence by a threat actor.\n\n\n#### Sparrow\n\n\n\n CISA created\n [Sparrow](https://github.com/cisagov/Sparrow) \n to help network defenders detect possible compromised accounts and applications in the Azure/M365 environment. The tool focuses on the narrow scope of user and application activity endemic to identity\\- and authentication\\-based attacks seen recently in multiple sectors. It is neither comprehensive nor exhaustive of available data. It is intended to narrow a larger set of available investigation modules and telemetry to those specific to recent attacks on federated identity sources and applications.\n \n\n\n\n*(Updated April 8, 2021\\):* \n CISA has\u00a0also created \"Aviary,\" which is a companion Splunk dashboard that can assist in visualizing and reviewing the output of Sparrow. Network defenders can find Aviary on\n [CISA's Sparrow GitHub page](https://github.com/cisagov/Sparrow) \n .\u00a0CISA advises network defenders to perform the following actions to use Sparrow:\n \n\n\n1. Use Sparrow to detect any recent domain authentication or federation modifications.\n   \n\n\t1. Domain and federation modification operations are uncommon and should be investigated.\n2. Examine logs for new and modified credentials applied to applications and service principals; delineate for the credential type. Sparrow can be used to detect the modification of service principals and application credentials.\n   \n\n\t1. Create a timeline for all credential changes, focusing on recent wholesale changes.\n\t2. Review the \u201ctop actors\u201d for activity in the environment and the number of credential modifications performed.\n\t3. Monitor changes in application and service principal credentials.\n\t4. Investigate any instances of excessive permissions being granted, including, but not limited to, Exchange Online, Microsoft Graph, and Azure AD Graph.\n3. Use Sparrow to detect privilege escalation, such as adding a service principal, user, or group to a privileged role.\n4. Use Sparrow to detect\n `OAuth` \n consent and users\u2019 consent to applications, which is useful for interpreting changes in adversary TTPs.\n5. Use Sparrow to identify anomalous Security Assertion Markup Language (SAML) token sign\\-ins by pivoting on the unified audit log UserAuthenticationValue of 16457, which is an indicator of how a SAML token was built and is a potential indicator for forged SAML tokens.\n   \n\n\t1. Note that this TTP has not been the subject of significant published security research but may indicate an unusual usage of a token, such as guest access for external partners to M365 resources.\n6. Review the PowerShell logs that Sparrow exports.\n   \n\n\t1. Review PowerShell mailbox sign\\-ins and validate that the logins are legitimate actions.\n\t2. Review PowerShell usage for users with PowerShell in the environment.\n7. Use Sparrow to check the Graph API application permissions of all service principals and applications in M365/Azure AD.\n   \n\n\t1. Investigate unusual activity regarding Microsoft Graph API permissions (using either the legacy\n\t <https://graph.windows.net/>\n\t or\n\t <https://graph.microsoft.com>\n\t ). Graph is used frequently as part of these TTPs, often to access and manipulate mailbox resources.\n8. Review Sparrow\u2019s listed tenant\u2019s Azure AD domains, to see if the domains have been modified.\n9. For customers with G5 or E5 licensing levels, review MailItemsAccessed for insight into what application identification (ID) was used for accessing users\u2019 mailboxes. Use Sparrow to query for a specific application ID using the app id investigation capability, which will check to see if it is accessing mail or file items.\n   \n\n\t1. The MailItemsAccessed event provides audibility for mailbox data accessed via mail protocols or clients.\n\t2. By analyzing the MailItemsAccessed action, incident responders can determine which user mailbox items have been accessed and potentially exfiltrated by a threat actor. This event will be recorded even in some situations where the message was not necessarily read interactively (e.g., bind or sync).\n\t [\\[5]](https://docs.microsoft.com/en-us/microsoft-365/compliance/advanced-audit?view=o365-worldwide)\n\t3. The resulting suspicious application ID can provide incident responders with a pivot to detect other suspicious applications that require additional analysis.\n\t4. Check for changes to applications with regards to the accessing of resources such as mail or file items.\n\n\n\n*(Updated April 8, 2021\\):* \n Aviary can be used to assist with performing the above tasks. To install Aviary, after running Sparrow:\n \n\n\n1. Ingest comma separated values (CSV) output from the Sparrow PowerShell script into Splunk.\n   \n\n\t1. Sparrow output will have the following default filenames, which should not be modified:\n\t `AppUpdate_Operations_Export.csv` \n\t ,\n\t `AppRoleAssignment_Operations_Export.csv` \n\t ,\n\t `Consent_Operations_Export.csv` \n\t ,\n\t `Domain_List.csv` \n\t ,\n\t `Domain_Operations_Export.csv` \n\t ,\n\t `FileItems_Operations_Export.csv` \n\t ,\n\t `MailItems_Operations_Export.csv` \n\t ,\n\t `PSLogin_Operations_Export.csv` \n\t ,\n\t `PSMailbox_Operations_Export.csv` \n\t ,\n\t `SAMLToken_Operations_Export.csv` \n\t ,\n\t `ServicePrincipal_Operations_Export.csv`\n2. Copy and paste the contents of the .xml file (aviary.xml in the root directory) into a new dashboard.\n3. Use the data selection filters to point to the indexed Sparrow data (see figure 1\\)\n\n\n\n![]()\n\n\n\n\n Figure 1: Data Selection Filters\n \n\n\n\n\n\n\n#### Hawk\n\n\n\n Hawk is an open\\-source, PowerShell\\-driven, community\\-developed tool network defenders can use to quickly and easily gather data from O365 and Azure for security investigations. Incident responders and network defenders can investigate specific user principals or the entire tenant. Data it provides include IP addresses and sign\\-in data. Additionally, Hawk can track IP usage for concurrent login situations.\n \n\n\n\n Hawk users should review login details for administrator accounts and take the following steps.\n \n\n\n#### CrowdStrike Azure Reporting Tool\n\n\n\n[CrowdStrike's Azure Reporting Tool](https://github.com/CrowdStrike/CRT) \n (CRT) can help network defenders analyze their Microsoft Azure AD and M365 environment to help organizations analyze permissions in their Azure AD tenant and service configuration. This tool has minor overlap with Sparrow; it shows unique items, but it does not cover the same areas. CISA is highlighting this tool because it is one of the only free, open\\-source tools available to investigate this activity and could be used to complement Sparrow.\n \n\n\n#### Detection Tool Distinctions\n\n\n#### Detection Methods\n\n\n\n Microsoft breaks the threat actor\u2019s recent activity into four primary stages, which are described below along with associated detection methods. Microsoft describes these stages as beginning with all activity after the compromise of the on\\-premises identity solution, such as ADFS.\n [\\[6]](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610 ) \n\n\n\n\n Note: this step provides an entry vector to cloud technology environments, and is unnecessary when the threat actor has compromised an identity solution or credential that allows the APT direct access to the cloud(e.g., without leveraging the SolarWinds Orion vulnerability).\n \n\n\n\n**Stage 1: Forging a trusted authentication token used to access resources that trust the on\\-premises identity provider** \n\n\n\n\n These attacks (often referred to as \u201cGolden Security Assertion Markup Language\u201d attacks) can be analyzed using a combination of cloud\\-based and standard on\\-premises techniques.\n [\\[7]](https://www.sygnia.co/golden-saml-advisory) \n For example, network defenders can use\n `OAuth` \n claims for specific principals made at the Azure AD level and compare them to the on\\-premises identity.\n \n\n\n\n Export sign\\-in logs from the Azure AD portal and look at the Authentication Method field.\n \n\n\n\n**Note** \n : at portal.azure.com, click on a user and review the authentication details (e.g., date, method, result). Without Sentinel, this is the only way to get these logs, which are critical for this effort.\n \n\n\n\n***Detection Method 1: Correlating service provider login events with corresponding authentication events in Active Directory Federation Services (ADFS) and Domain Controllers***\n\n\n\n\n Using SAML single sign\\-on, search for any logins to service providers that do not have corresponding event IDs 4769, 1200, and 1202 in the domain.\n \n\n\n\n***Detection Method 2: Identifying certificate export events in ADFS***\n\n\n\n\n Look for:\n \n\n\n\n***Detection Method 3: Customizing SAML response to identify irregular access***\n\n\n\n\n This method serves as prevention for the future (and would only detect future, not past, activity), as it helps identify irregularities from the point of the change forward. Organizations can modify SAML responses to include custom elements for each service provider to monitor and detect any anomalous requests.\n [\\[8]](https://www.sygnia.co/golden-saml-advisory) \n\n\n\n\n***Detection Method 4: Detecting malicious ADFS trust modification***\n\n\n\n\n A threat actor who gains administrative access to ADFS can add a new, trusted ADFS rather than extracting the certificate and private key as part of a standard Golden SAML attack.\n [\\[9]](https://www.sygnia.co/golden-saml-advisory) \n  \n\n  \n\n Network defenders should look for:\n \n\n\n\n**Stage 2: Using the forged authentication token to create configuration changes in the Service Provider, such as Azure AD (establishing a foothold)** \n\n\n\n\n After the threat actor has compromised the on\\-premises identity provider, they identify their next series of objectives by reviewing activity in the Microsoft Cloud activity space (Microsoft Azure and M365 tenants).\n \n\n\n\n The threat actor uses the ability to forge authentication tokens to establish a presence in the cloud environment. The actor adds additional credentials to an existing service principal. Once the threat actor has impersonated a privileged Azure AD account, they are likely to further manipulate the Azure/M365 environment (action on objectives in the cloud).\n \n\n\n\n Network defenders should take the following steps.\n \n\n\n\n**Stage 3: Acquiring an\n `OAuth` \n access token for the application using the forged credentials added to an existing application or service principal and calling APIs with the permissions assigned to that application** \n\n\n\n\n In some cases, the threat actor has been observed adding permissions to existing applications or service principals. Additionally the actor has been seen establishing new applications or service principals briefly and using them to add permissions to the existing applications or service principals, possibly to add a layer of indirection (e.g., using it to add a credential to another service principal, and then deleting it).\n [\\[11]](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610 ) \n\n\n\n\n Network defenders should use Sparrow to:\n \n\n\n\n**Stage 4: Once access has been established, the threat actor Uses Microsoft Graph API to conduct action on objectives from an external RESTful API (queries impersonating existing applications).** \n\n\n\n\n Network defenders should:\n \n\n\n#### Microsoft Telemetry Nuances\n\n\n\n The existing tools and techniques used to evaluate cloud\\-based telemetry sources present challenges not represented in traditional forensic techniques. Primarily, the amount of telemetry retention is far less than the traditional logging facilities of on\\-premises data sources. Threat actor activity that is more than 90 days old is unlikely to have been saved by traditional sources or be visible with the Microsoft M365 Management API or in the UAL.\n \n\n\n\n Service principal logging is available using the Azure Portal via the \"Service Principal Sign\\-ins\" feature. Enable settings in the Azure Portal (see \u201cDiagnostic Setting\u201d) to ingest logs into Sentinel or a third\\-party security information and event management (SIEM) tool. An Azure Premium P1 or Premium P2 license is necessary to access this setting as well as other features, such as a log analytics workspace, storage account, or event hub.\n [\\[12]](https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-all-sign-ins ) \n These logs must be downloaded manually if not ingested by one of the methods listed in the Detection Methods section.\n \n\n\n\n Global Administrator rights are often required by tools other than Hawk and Sparrow to evaluate M365 cloud security posture. Logging capability and visibility of data varies by licensing models and subscription to premium services, such as Microsoft Defender for O365 and Azure Sentinel. According to CrowdStrike, \"There was an inability to audit via API, and there is the requirement for global admin rights to view important information which we found to be excessive. Key information should be easily accessible.\"\n [\\[13]](https://www.crowdstrike.com/blog/crowdstrike-launches-free-tool-to-identify-and-help-mitigate-risks-in-azure-active-directory/) \n\n\n\n\n Documentation for specific event codes, such as UserAuthenticationMethod 16457, which may indicate a suspicious SAML token forgery, is no longer available in the M365 Unified Access Log. Auditing narratives on some events no longer exist as part of core Microsoft documentation sources.\n \n\n\n\n The use of industry\\-standard SIEMs for log detection is crucial for providing historical context for threat hunting in Microsoft cloud environments. Standard G3/E3 licenses only provide 90 days of auditing; with the advanced auditing license that is provided with a G5/E5 license, audit logs can be extended to retain information for a year. CISA notes that this license change is proactive, rather than reactive: it allows enhanced visibility and features for telemetry from the moment of integration but does not provide retroactive visibility on previous events or historical context.\n \n\n\n\n A properly configured SIEM can provide:\n \n\n\n\n Built\\-in tools, such as Microsoft Cloud Services and M365 applications, provide much of the same visibility available from custom tools and are mapped to the MITRE ATT\\&CK framework and easy\\-to\\-understand dashboards.\n [\\[14]](https://splunkbase.splunk.com/app/3786/) \n However, these tools often do not have the ability to pull historical data older than seven days. Therefore, storage solutions that appropriately meet governance standards and usability metrics for analysts for the SIEM must be carefully planned and arranged.\n \n\n\n1. Ingest comma separated values (CSV) output from the Sparrow PowerShell script into Splunk.\n   \n\n\t1. Sparrow output will have the following default filenames, which should not be modified:\n\t `AppUpdate_Operations_Export.csv` \n\t ,\n\t `AppRoleAssignment_Operations_Export.csv` \n\t ,\n\t `Consent_Operations_Export.csv` \n\t ,\n\t `Domain_List.csv` \n\t ,\n\t `Domain_Operations_Export.csv` \n\t ,\n\t `FileItems_Operations_Export.csv` \n\t ,\n\t `MailItems_Operations_Export.csv` \n\t ,\n\t `PSLogin_Operations_Export.csv` \n\t ,\n\t `PSMailbox_Operations_Export.csv` \n\t ,\n\t `SAMLToken_Operations_Export.csv` \n\t ,\n\t `ServicePrincipal_Operations_Export.csv`\n2. Copy and paste the contents of the .xml file (aviary.xml in the root directory) into a new dashboard.\n3. Use the data selection filters to point to the indexed Sparrow data (see figure 1\\)\n4. 1. Investigate high\\-value administrative accounts to detect anomalous or unusual activity (Global Admins).\n\t2. Enable PowerShell logging, and evaluate PowerShell activity in the environment not used for traditional or expected purposes.\n\t   \n\t\n\t\t1. PowerShell logging does not reveal the exact\n\t\t `cmdlet` \n\t\t that was run on the tenant.\n\t3. Look for users with unusual sign\\-in locations, dates, and times.\n\t4. Check permissions of service principals and applications in M365/Azure AD.\n\t5. Detect the frequency of resource access from unusual places. Use the tool to pivot to a trusted application and see if it is accessing mail or file items.\n\t6. Review mailbox rules and recent mailbox rule changes.\n\t* Sparrow differs from CRT by looking for specific indicators of compromise associated with the recent attacks.\n\t* CRT focuses on the tenant\u2019s Azure AD permissions and Exchange Online configuration settings instead of the unified audit log, which gives it a different output from Sparrow or Hawk.\n\t* CRT returns the same broad scope of application/delegated permissions for service principals and applications as Hawk.\n\t* As part of its investigation, Sparrow homes in on a narrow set of application permissions given to the Graph API, which is common to the recent attacks.\n\t* CRT looks at Exchange Online federation configuration and federation trust, while Sparrow focuses on listing Azure AD domains.\n\t* Among the items network defenders can use CRT to review are delegated permissions and application permissions, federation configurations, federation trusts, mail forwarding rules, service principals, and objects with KeyCredentials.\n\t1. The IP address and Activity\\_ID in EventCode 410 and the Activity\\_ID and Instance\\_ID in EventCode 500\\.\n\t2. Export\\-PfxCertificate or certutil\\-exportPFX in Event IDs 4103 and 4104, which may include detection of a certificate extraction technique.\n\t3. Deleted certificate extraction with ADFSdump performed using Sysmon Event ID 18 with the pipe name \\\\microsoft\\#\\#wid\\\\tsql\\\\query (exclude processes regularly making this pipe connection on the machine).\n\t4. Event ID 307 (The Federation Service configuration was changed), which can be correlated to relevant Event ID 510 with the same instance ID for change details (Event ID 510 with the same Instance ID could be more than one event per single Event ID 307 event).\n\t5. Event ID 307 (The Federation Service configuration was changed), which can be correlated to relevant Event ID 510 with the same Instance ID for change details. (Event ID 510 with the same Instance ID could be more than one event per single Event ID 307 event.)\n\t\t1. Review events, particularly searching for Configuration: Type: IssuanceAuthority where Property Value references an unfamiliar domain.\n\t6. Possible activity of an interrogating ADFS host by using ADFS PowerShell plugins. Look for changes in the federation trust environment that would indicate new ADFS sources.\n\t7. Audit the creation and use of service principal and application credentials. Sparrow will detect modifications to these credentials.\n\t   \n\t\n\t\t1. Look for unusual application usage, such as dormant or forgotten applications being used again.\n\t\t2. Audit the assignment of credentials to applications that allow non\\-interactive sign\\-in by the application.\n\t8. Look for unexpected trust relationships that have been added to Azure AD. (Download the last 30 days of non\\-interactive sign\\-ins from the Azure portal or use Azure Sentinel.).\n\t [\\[10]](https://docs.microsoft.com/en-us/azure/azure-monitor/reference/tables/aadserviceprincipalsigninlogs )\n\t9. Use Hawk (and any sub\\-modules available) to run an investigation on a specific user. Hawk will provide IP addresses, sign\\-in data, and other data. Hawk can also track IP usage in concurrent login situations.\n\t10. Review login details for administrator accounts (e.g., high\\-value administrative accounts, such as Global Admins). Look for unusual sign\\-in locations, dates, and times.\n\t11. Review new token validation time periods with high values and investigate whether the changes are legitimate or a threat actor\u2019s attempts to gain persistence.\n\t12. Examine highly privileged accounts; specifically using sign\\-in logs, look for unusual sign\\-in locations, dates, and times.\n\t13. Create a timeline for all credential changes.\n\t14. Monitor changes in application credentials (the script will export into csv named AppUpdate\\_Operations\\_Export).\n\t15. Detect service principal credentials change and service principal change (e.g., if an actor adds new permissions or expands existing permissions).\n\t   \n\t\n\t\t1. Export and view this activity via the ServicePrincipal\\_Operations\\_Export.\n\t16. Record\n\t `OAuth` \n\t consent and consent to applications\n\t   \n\t\n\t\t1. Export and view this record via the Consent\\_Operations\\_Export file.\n\t17. Investigate instances of excessive high permissions, including, but not limited to Exchange Online, Microsoft Graph, and Azure AD Graph.\n\t   \n\t\n\t\t1. Review Microsoft Graph API permissions granted to service principals.\n\t\t2. Export and view this activity via the ApplicationGraphPermissions csv file.\n\t\t   \n\t\t\n\t\t\t1. **Note:** \n\t\t\t Hawk can also return the full list of service principal permissions for further investigation.\n\t\t3. Review top actors and the amount of credential modifications performed.\n\t\t4. Monitor changes in application credentials.\n\t18. Identify manipulation of custom or third\\-party applications.\n\t   \n\t\n\t\t1. Network defenders should review the catalog of custom or third\\-party vendors with applications in the Microsoft tenant and perform the above interrogation principles on those applications and trusts.\n\t19. Review modifications to federation trust settings.\n\t   \n\t\n\t\t1. Review new token validation time periods with high values and investigate whether this was a legitimate change or an attempt to gain persistence by the threat actor.\n\t\t   \n\t\t\n\t\t\t1. The script detects the escalation of privileges, including the addition of Service Principals (SP) to privileged roles. Export this data into csv called AppRoleAssignment\\_Operations\\_Export.\n\t20. In MailItemsAccessed operations, found within the Unified Audit Log (UAL), review the application ID used (requires G5 or E5 license for this specific detail).\n\t21. Query the specific application ID, using the Sparrow script\u2019s app ID investigation capability to interrogate mail and file items accessed for that applicationID (Use the application ID utility for any other suspicious apps that require additional analysis.).\n\t22. Check the permissions of an application in M365/Azure AD using Sparrow.\n\t   \n\t\n\t\t1. Hawk will return Azure\\_Application\\_Audit, and Sparrow will return ApplicationGraphPermissions.\n\t\t2. Network defenders will see the IP address that Graph API uses.\n\t\t3. Note: the Microsoft IP address may not show up as a virtual private server/anonymized endpoint.\n\t23. Investigate a specific service principal, if it is a user\\-specific user account, in Hawk. This activity is challenging to see without Azure Sentinel or manually downloading and reviewing logs from the sign\\-in portal.\n\t24. Longer term storage of log data.\n\t25. Cross correlation of log data with endpoint data and network data (such as those produced by ADFS servers), endpoint detection and response data, and identity provider information.\n\t26. Ability to query use of application connectors in Azure.\n\n\n\n### Contact Information\n\n\n\n\n CISA encourages recipients of this report to contribute any additional information that they may have related to this threat. For any questions related to this report, please contact CISA at\n \n\n\n* 1\\-888\\-282\\-0870 (From outside the United States: \\+1\\-703\\-235\\-8832\\)\n* [central@cisa.dhs.gov](mailto:central@cisa.dhs.gov) \n (UNCLASS)\n* us\\-cert@dhs.sgov.gov (SIPRNET)\n* us\\-cert@dhs.ic.gov (JWICS)\n\n\n\n CISA encourages you to report any suspicious activity, including cybersecurity incidents, possible malicious code, software vulnerabilities, and phishing\\-related scams. Reporting forms can be found on the CISA/US\\-CERT homepage at\n [http://www.us\\-cert.cisa.gov/](http://www.us-cert.cisa.gov/) \n .\n \n\n\n### Resources\n\n\n\n Azure Active Directory Workbook to Assess Solorigate Risk:\n [https://techcommunity.microsoft.com/t5/azure\\-active\\-directory\\-identity/azure\\-ad\\-workbook\\-to\\-help\\-you\\-assess\\-solorigate\\-risk/ba\\-p/2010718](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/azure-ad-workbook-to-help-you-assess-solorigate-risk/ba-p/2010718) \n\n\n\n\n Volexity \\- Dark Halo Leverages SolarWinds Compromise to Breach Organizations:\n [https://www.volexity.com/blog/2020/12/14/dark\\-halo\\-leverages\\-solarwinds\\-compromise\\-to\\-breach\\-organizations/](https://www.volexity.com/blog/2020/12/14/dark-halo-leverages-solarwinds-compromise-to-breach-organizations/) \n\n\n\n\n How to Find Activity with Sentinel:\n [https://www.verboon.info/2020/10/monitoring\\-service\\-principal\\-sign\\-ins\\-with\\-azuread\\-and\\-azure\\-sentinel/](https://www.verboon.info/2020/10/monitoring-service-principal-sign-ins-with-azuread-and-azure-sentinel/) \n\n\n\n\n Third\\-Party Walkthrough of the Attack:\n [https://dirkjanm.io/azure\\-ad\\-privilege\\-escalation\\-application\\-admin/](https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/) \n\n\n\n\n National Security Agency Advisory on Detecting Abuse of Authentication Mechanisms:\n [https://media.defense.gov/2020/Dec/17/2002554125/\\-1/\\-1/0/AUTHENTICATION\\_MECHANISMS\\_CSA\\_U\\_OO\\_198854\\_20\\.PDF](https://media.defense.gov/2020/Dec/17/2002554125/-1/-1/0/AUTHENTICATION_MECHANISMS_CSA_U_OO_198854_20.PDF) \n\n\n\n\n Microsoft 365 App for Splunk:\n <https://splunkbase.splunk.com/app/3786/>\n\n\n\n\n CISA Remediation Guidance:\n [https://us\\-cert.cisa.gov/ncas/alerts/aa20\\-352a](https://us-cert.cisa.gov/ncas/alerts/aa20-352a) \n\n\n\n\n### References\n\n\n\n\n[\\[1] ZDNet: A Second Hacking Group has Targeted SolarWinds Systems](https://www.zdnet.com/article/a-second-hacking-group-has-targeted-solarwinds-systems/) \n\n\n[\\[2] CISA: Supply Chain Compromise](https://www.cisa.gov/supply-chain-compromise) \n\n\n[\\[3] Microsoft SolarWinds Post\\-Compromise Hunting with Azure Sentinel](https://techcommunity.microsoft.com/t5/azure-sentinel/solarwinds-post-compromise-hunting-with-azure-sentinel/ba-p/1995095) \n\n\n[\\[4] Microsoft Solorigate Resource Center](https://msrc-blog.microsoft.com/2020/12/21/december-21st-2020-solorigate-resource-center/) \n\n\n[\\[5] Advanced Audit in Microsoft 365](https://docs.microsoft.com/en-us/microsoft-365/compliance/advanced-audit?view=o365-worldwide) \n\n\n[\\[6] Microsoft: Understanding \u201cSolorigate\u2019s\u201d Identity IOCs](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610) \n\n\n[\\[7] Detection and Hunting of Golden SAML Attack:](https://www.sygnia.co/golden-saml-advisory) \n\n\n[\\[8] Ibid](https://www.sygnia.co/golden-saml-advisory) \n\n\n[\\[9] Ibid](https://www.sygnia.co/golden-saml-advisory) \n\n\n[\\[10] Microsoft: AADServicePrincipalSignInLogs](https://docs.microsoft.com/en-us/azure/azure-monitor/reference/tables/aadserviceprincipalsigninlogs) \n\n\n[\\[11] Microsoft: Understanding \u201cSolorigate\u2019s\u201d Identity IOCs](https://techcommunity.microsoft.com/t5/azure-active-directory-identity/understanding-quot-solorigate-quot-s-identity-iocs-for-identity/ba-p/2007610) \n\n\n[\\[12] Azure Active Directory Sign\\-in Activity Reports](https://docs.microsoft.com/en-us/azure/active-directory/reports-monitoring/concept-all-sign-ins) \n\n\n[\\[13] CrowdStrike: CrowdStrike Launches Free Tool to Identify and Help Mitigate Risks in Azure Active Directory](https://www.crowdstrike.com/blog/crowdstrike-launches-free-tool-to-identify-and-help-mitigate-risks-in-azure-active-directory/) \n\n\n[\\[14] Microsoft 365 App for Splunk](https://splunkbase.splunk.com/app/3786/) \n\n\n### Revisions\n\n\n\n\n Initial version: January 8, 2021\\|February 4, 2021: Removed link and section for outdated product feedback form\\|April 8, 2021: Added Aviary Dashboard information\\|April 15, 2021: Added Attribution Statement\n \n\n\n\n\n\n\n\n\n\n\n This product is provided subject to this\n [Notification](/notification \"Follow link\") \n and this\n [Privacy \\& Use](/privacy-policy \"Follow link\") \n policy.\n \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPlease share your thoughts\n--------------------------\n\n\n\n We recently updated our anonymous\n [product survey](https://www.surveymonkey.com/r/CISA-cyber-survey?product=https://www.cisa.gov/news-events/cybersecurity-advisories/aa21-008a) \n ; we\u2019d welcome your feedback.\n \n\n\n\n\n\n\n\n\n\n\n\n\nRelated Advisories\n------------------\n\n\n\n\n\n\n\n\n\n\n Jul 11, 2024\n \n\n\n Cybersecurity Advisory \\| AA24\\-193A\n \n\n### [CISA Red Team\u2019s Operations Against a Federal Civilian Executive Branch Organization Highlights the Necessity of Defense\\-in\\-Depth](/news-events/cybersecurity-advisories/aa24-193a)\n\n\n\n\n\n\n\n\n\n\n\n Jul 08, 2024\n \n\n\n Cybersecurity Advisory \\| AA24\\-190A\n \n\n### [People\u2019s Republic of China (PRC) Ministry of State Security APT40 Tradecraft in Action](/news-events/cybersecurity-advisories/aa24-190a)\n\n\n\n\n\n\n\n\n\n\n\n May 10, 2024\n \n\n\n Cybersecurity Advisory \\| AA24\\-131A\n \n\n### [\\#StopRansomware: Black Basta](/news-events/cybersecurity-advisories/aa24-131a)\n\n\n\n\n\n\n\n\n\n\n\n Apr 18, 2024\n \n\n\n Cybersecurity Advisory \\| AA24\\-109A\n \n\n### [\\#StopRansomware: Akira Ransomware](/news-events/cybersecurity-advisories/aa24-109a)\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n[Return to top](#) \n\n\n\n\n* [Topics](/topics)\n* [Spotlight](/spotlight)\n* [Resources \\& Tools](/resources-tools)\n* [News \\& Events](/news-events)\n* [Careers](/careers)\n* [About](/about)\n\n\n\n\n\n\n\n\n[Cybersecurity \\& Infrastructure Security Agency](/ \"Go to the Cybersecurity & Infrastructure Security Agency homepage\")\n\n\n* [Facebook](https://www.facebook.com/CISA)\n* [Twitter](https://twitter.com/CISAgov)\n* [LinkedIn](https://www.linkedin.com/company/cybersecurity-and-infrastructure-security-agency)\n* [YouTube](https://www.youtube.com/@cisagov)\n* [Instagram](https://www.instagram.com/cisagov)\n* [RSS](/subscribe-updates-cisa)\n\n\n\n\n CISA Central\n \n[1\\-844\\-Say\\-CISA](tel:1-844-Say-CISA) \n[SayCISA@cisa.gov](mailto:SayCISA@cisa.gov) \n\n\n\n\n\n\n\n\n\n\n\n DHS Seal\n \n\n\n CISA.gov\n \n\n An official website of the U.S. Department of Homeland Security\n \n\n\n* [About CISA](/about \"About CISA\")\n* [Budget and Performance](https://www.dhs.gov/performance-financial-reports \"Budget and Performance\")\n* [DHS.gov](https://www.dhs.gov \"Department of Homeland Security\")\n* [Equal Opportunity \\& Accessibility](/oedia \"Equal Opportunity & Accessibility\")\n* [FOIA Requests](https://www.dhs.gov/foia \"FOIA Requests\")\n* [No FEAR Act](/no-fear-act \"No FEAR Act Reporting\")\n* [Office of Inspector General](https://www.oig.dhs.gov/ \"Office of Inspector General\")\n* [Privacy Policy](/privacy-policy \"Privacy Policy\")\n* [Subscribe](https://public.govdelivery.com/accounts/USDHSCISA/subscriber/new?topic_id=USDHSCISA_138 \"Subscribe to Email Updates\")\n* [The White House](https://www.whitehouse.gov/ \"The White House\")\n* [USA.gov](https://www.usa.gov/ \"USA.gov\")\n* [Website Feedback](/forms/feedback \"Website Feedback\")\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", "cves": [], "techniques": ["T1110.001", "T1110.003"], "advisory": "aa21-008a", "title": "Detecting Post-Compromise Threat Activity in Microsoft Cloud Environments | CISA", "source": "cybersecurity-advisories", "id": "6a21f1d7dd5b48da9555dd2fa35967315856968c8ac372bfdfd78b20deec8ab5"}