{
  "markdown": "  \nU/OO/198854 -20 | PP-20-1485  | Dec 2020  Rev. 1.0 \nNational Security Agency | Cybersecurity Advisory  \nDetecting Abuse of Authentication Mechanisms   \nSummary  \nMalicious cyber  actors are abusing trust in federated authentication environments to access protected data. The \nexploitation occurs after the actor s have gained initial access to a victim s on -premises  network. The actor s leverage  \nprivileged access  in the on -premises environment to subvert the mechanisms that the organization uses to grant  access \nto cloud  and on -premises  resources and/or to compromise administrator credentials with the ab ility to manage cloud \nresources . The actor s demonstrate  two sets of tactics , techniques , and procedures (TTP) for gaining  access to the victim \nnetworks  cloud resources, often with a particular focus on organizational email.  \nIn the first TTP, the actor s compromise  on-premises components of a federated SSO infrastru cture  and steal  the \ncredential or private key that is used to sign Security Assertion Markup Language (SAML) tokens  (TA00061, T1552, \nT1552.004) . Using the private keys, t he actor s then forge trusted authentication tokens to access cloud resources. A \nrecent NSA Cybersecurity Advisory warned of actors exploiting a vulnerability in VMware Access2 and VMware Identity \nManag er3 that allowed them  to perform this TTP and abuse federated SSO infrastructure  [1]. While that example of this \nTTP may have previously been attributed to  nation -state actors, a wealth of actors could be leveraging this TTP f or their \nobjectives . This SAML forgery technique has been known and used by cyber actors  since at least 2017 [2]. \nIn a variation of the first TTP, i f the malicious cyber actor s are unable to obtain an on-premises signing key, they would \nattempt  to gain sufficient admin istrative  privilege s within the cloud  tenant to add a malicious  certificate trust relationship for \nforging SAML tokens.   \nIn the second TTP, the actor s leverage a compromised global administrator account to assign credentials to cloud \napplication  service principals  (identities for cloud applications that allow the applications to be invoked to access other \ncloud resources) . The actor s then invoke the application s credentials for  automated access  to cloud resources (often \nemail in particular ) that would otherwise be difficult for the actor s to access or would more easily be noticed as susp icious  \n(T1114, T1114.002) . \nNote that these TTPs (in and of themselves)  do not constitute vulnerabilities  in the design principles of federated identity \nmanagement, the SAML protocol , or on -premises and cloud identity services . The security of identity federation in any \ncloud environment directly depends on trust in the on -premises components that perform authentication, assign privil eges, \nand sign SAML tokens. If any of these components is compromised, then the trust in authentication tokens from the \ncomponents is misplaced and can be abused for unauthorized access.  \nIt is critical when running products that perform authentication that  the server and all the services that depend on it are \nproperly configured for secure operation and integration. Otherwise, SAML tokens could be forged, granting access to \nnumerous resources. Microsoft Active Directory Federation Services (ADFS) 4 is an identity federation technology used \nto federate identities with Active Directory (AD) 5, Azure Active Directory (AAD) 6, and other identity providers , such as \nVMware Identity Manager. By abusing the federated authentication, t he actors are not exploiting a vulnerability in ADFS, \nAD, or AAD, but rather abusing the trust established across the integrated components . Due to the popularity of ADFS, \nnumerous  actors target ADFS , as well as other identity providers trusted by ADFS (T1199) , to gain access to cloud \nservices , such as Microsoft Office 365. Once access is gained, the actors monitor or exfiltrate emails and documents \n                                            \n1 TA0006  and similar references are MITRE ATT&CK t actics and t echniques. MITRE and ATT&CK are registered trademarks of The MITRE Corporation.  \n2 VMware Access  is a registered trademark of VMware.  \n3 VMware Identity Manager  is a registered trademark of VMware.  \n4 Microsoft Active Directory Federation Services (ADFS)  is a registered trademark of Microsoft Corporation . \n5 Active Directory (AD)  is a registered trademark of Microsoft Corporation . \n6 Azure Active Directory (AAD)  is a registered trademark of Microsoft Corporation . \n\n \n \nU/OO/198854 -20 | PP-20-1485 | Dec 2020  Rev. 1.0 2 \nDetecting Federated Authentication Abuse  \nstored in Microsoft Office 3657 environments (T1114, T1114.002).  Therefore , when using ADFS, NSA recommends \nfollowing Microsofts8 best practices, especially for securing SAML tokens and requiring multi -factor authentication [3] [4]. \nRegardless of how the initial on -premises compromise occurred, detecting auth entication abuse can aid in detecting the \ncompromise and even contain it if responded to quickly enough. The recent SolarWinds Orion9 code compromise is one \nserious example of how on -premises systems can be compromised leading to abuse of federated authen tication and \nmalicious cloud access  [5] [6]. Affected customers are strongly recommended to  follow  CISAs Emergency Directive 20 -01 \nto perform incident response and take mitigation actions  [7]. \nMitigation Actions  \nTo defend against these TTPs , cloud tenants  must pay careful attention to locking down tenant SSO configuration and \nservice principal usage, as well as harden ing the systems that run on -premises i dentity and federation service s. \nMonitoring the use of SSO tokens and the use of service principals in the cloud can help detect the compromise of identity \nservices. While these techniques apply to all cloud environments that support on -premises federated authenticati on, the \nfollowing specific mitigations are focused on Microsoft Azure federation . Many of the techniques can be generalized to \nother environments . \nHarden Azure Authentication  and Authorization Configuration  \nAzure tenants can configure aspects of authentica tion and authorization in  Azure Active Directory (A AD). When possible, \nAAD should be configured  to reject authorization requests with tokens having  characteristics that deviate from common \npractices .  \n Refer to Microsoft guidance on securing privileged acce ss [8] [9] [10] [11];  \n Token claims should be consistent with organizational policy;  \nAzure tenants should follow basic security practices on locking down the use of service p rincipals : \n Review all tenant applications with credentials  and remove  if not necessary ; \nFollow  recommended AAD security practices.  \n Refer to  Microsoft guidance on requir ing and enfor cing Multi -Factor Authentication ( MFA ) [12] [13] [14]; \n Refer to Microsoft guidance on disabling legacy authentication to AAD [15]. \nHarden On -Premises Systems  \nThe ability of actors to conduct this attack hinges on the initial compromise of customer on -premises systems. Without \nadministrative access to the on -premises identity provider, actors would not be able to generate tokens for use in the \ncloud. Follow NSA guidance on locking down endpoint systems, beginning with keeping systems patched and software \nupdated [20].  \nStrongly c onsider deploying a FIPS validated Hardware Security Module (HSM) to store on -premises token signing \ncertifica te private keys. An HSM , aggressively updated,  makes it very difficult for actors who have compromised the \nsystem to steal the private keys and use them outside of the network  [3].  \nEnsure core privileged cloud administrative us ers, groups, and roles are not impacted by data synchronized from on -\npremises environments, and that cloud administrative roles do not authenticate with SMAL SSO, but instead rely on \ncloud -only authentication.  \n                                            \n7 Microsoft Office 365 is a registered trademark of Microsoft Corporation . \n8 Microsoft is a registered trademark of Microsoft Corporation . \n9 SolarWinds Orion  is a registered trademark of SolarWinds Worldwide LCC.  \n\n \n \nU/OO/198854 -20 | PP-20-1485 | Dec 2020  Rev. 1.0 3 \nDetecting Federated Authentication Abuse  \nDetection  \nDetecting forged SAML token usage  is a shared responsibility between the cloud provider and tenant . The cloud provider  \nleverages its position to look for sophisticated attacks against customers , while the tenant can detect indications in both \non-premises and cloud logs . For this reason it is important to inspect and retain your logs for analysis.  \nWhen available, utilize  add-on cloud services and log correlation tools that use environmental values and sophisticated \nAI/ML algorithms to detect unusual patterns in user authe ntication and authorization . For those organizations using the \nAzure cloud10, Microsoft offers tools including  Azure AD Identity Protection11, Microsoft Cloud Application Security12, \nand Azure Sentinel, but other third -party products may be used to perform  log analysis as well.  [16] [17]. \nExamin e logs for suspicious tokens  that do not match the baseline for SAML token s that are typical for the tenant , and \naudit SAML token use to detect  anomalies , for example:  \n Tokens with an unusually lon g lifetime;  \n Tokens with unusual claims that do not match organizational policy;  \n Tokens that claim to have been authenticated using a method that is not used by the organization (e.g., MFA \nwhen the organization does not  use MFA , or MFA by a provider that does not usually perform MFA ); \n Tokens presented without corresponding log entries, such as tokens with MFA claims where there is no \ncorresponding MFA system transaction, or tokens consumed at the resource with no corresp onding federation \nserver transaction.  \n Tokens that  include a claim th at it is for inside the corporate network  when it is not ; \n Tokens that are used to access cloud resources that do not have records of being created by the on -premises \nidentity provider in i ts logs  \nExamine logs for the suspicious use of s ervice principals : \n Audit the creation and use of service principal credentials ; \n In particular, look for unusual application  usage, such as a dormant or forgotten application  being used again ; \n Audit the assign ment of  credentials to application s that  allow s non-interactive sign -in by the application  [18] [19]. \nLook for unexpected trust relationship s that have been added to  AAD [18]. \nConsider using Azure Active Directory  as the Authoritative Identity Provider  \nBy consolidating identity and access natively in the cloud, tenants relieve themselves from the burden of managing th e \nfederation of authentication and the on -premises  service , and gain more of the protections that the cloud provider has in \nplace, including system hardening, configuration and monitoring. The  drawback of doing this is that SSO may not work \nacross on -premises and cloud resources and the tenant must trust the cloud provider to host user credential information.  \n \n \n \n \n                                            \n10 Azure cloud  is a registered trademark of Microsoft Corporation . \n11 Azure AD Identity Protection  is a registered trademark of Microsoft Corporation . \n12 Microsoft Cloud Application Security  is a registered trademark of Microsoft Corporation . \n\n \n \nU/OO/198854 -20 | PP-20-1485 | Dec 2020  Rev. 1.0 4 \nDetecting Federated Authentication Abuse  \n \nWorks Cited  \n[1]  NSA, \"Russian State -Sponsored Actors Exploiting Vulnerability in VMware Workspace ONE Access Using Compromised \nCredentials,\" NSA, 7 Dec 2020. [Online]. Available: h ttps://media.defense.gov/2020/Dec/07/2002547071/ -1/-\n1/0/CSA_VMWARE%20ACCESS_U_OO_195976_20.PDF. [Accessed 11 Dec 2020].  \n[2]  S. Reiner, \"Golden SAML: Newly Discovered Attack Technique Forges Authentication to Cloud Apps,\" CyberArk, 21 Nov 2017. \n[Online]. Available: https://www.cyberark.com/resources/threat -research -blog/golden -saml -newly -discovered -attack -technique -\nforges -authentication -to-cloud -apps. [Accessed 11 Dec 2020].  \n[3]  Microsoft, \"Best practices for securing Active Directory Federation Services ,\" Microsoft, 31 May 2017. [Online]. Available: \nhttps://docs.microsoft.com/en -us/windows -server/identity/ad -fs/deployment/best -practices -securing -ad-fs. [Accessed 9 Dec 2020].  \n[4]  Microsoft, \"Best Practices for Secure Planning and Deployment of AD FS,\" M icrosoft, 31 May 2017. [Online]. Available: \nhttps://docs.microsoft.com/en -us/windows -server/identity/ad -fs/design/best -practices -for-secure -planning -and-deployment -of-ad-\nfs. [Accessed 9 Dec 2020].  \n[5]  L. SolarWinds Worldwide, \"SolarWinds Security Advisor y,\" 15 December 2020. [Online]. Available: \nhttps://www.solarwinds.com/securityadvisory. [Accessed 15 December 2020].  \n[6]  M. S. R. Center, \"Customer Guidance on Recent Nation -State Cyber Attacks,\" 13 December 2020. [Online]. Available: \nhttps://msrc -blog.m icrosoft.com/2020/12/13/customer -guidance -on-recent -nation -state -cyber -attacks/. [Accessed 15 December \n2020].  \n[7]  Cybersecurity and Infrastructure Security Agency, \"Emergency Directive 21 -01: Mitigate SolarWinds Orion Code Compromise,\" \n13 December 2020. [Online]. Available: https://cyber.dhs.gov/ed/21 -01/. [Accessed 15 December 2020].  \n[8]  Microsoft, \"Securing privileged access for hybrid and cloud deployments in Azure AD,\" Microsoft, 5 Nov 2020. [Online]. Availa ble: \nhttps://docs.microsoft.com/en -us/azur e/active -directory/roles/security -planning. [Accessed 11 Dec 2020].  \n[9]  Microsoft, \"Securing privileged access,\" Microsoft, 25 Feb 2019. [Online]. Available: https://docs.microsoft.com/en -us/windows -\nserver/identity/securing -privileged -access/securing -privileged -access. [Accessed 11 Dec 2020].  \n[10]  Microsoft, \"Privileged Access Workstations,\" Microsoft, 13 Mar 2019. [Online]. Available: https://docs.microsoft. com/en -\nus/windows -server/identity/securing -privileged -access/privileged -access -workstations. [Accessed 11 Dec 2020].  \n[11]  Microsoft, \"Active Directory administrative tier model,\" Microsoft, 14 Feb 2019. [Online]. Available: https://docs.microsoft. com/en -\nus/windows -server/identity/securing -privileged -access/securing -privileged -access -reference -material. [Accessed 11 Dec 2020].  \n[12]  Microsoft, \"Conditional Access: Require MFA for Azure management,\" Microsoft, 26 May 2020. [Online]. Available: \nhttps://docs .microsoft.com/en -us/azure/active -directory/conditional -access/howto -conditional -access -policy -azure -management. \n[Accessed 9 Dec 2020].  \n[13]  Microsoft, \"Conditional Access: Require MFA for administrators,\" Microsoft, 3 Aug 2020. [Online]. Available: \nhttps://docs.microsoft.com/en -us/azure/active -directory/conditional -access/howto -conditional -access -policy -admin -mfa. [Accessed \n9 Dec 2020].  \n[14]  Microsoft, \"Conditional Access: Require MFA for all users,\" Microsoft, 26 May 2020. [Online]. Available: \nhttps:/ /docs.microsoft.com/en -us/azure/active -directory/conditional -access/howto -conditional -access -policy -all-users -mfa. \n[Accessed 9 Dec 2020].  \n[15]  Microsoft, \"How to: Block legacy authentication to Azure AD with Conditional Access,\" Microsoft, 5 Nov 2020. [O nline]. Available: \nhttps://docs.microsoft.com/en -us/azure/active -directory/conditional -access/block -legacy -authentication. [Accessed 9 Dec 2020].  \n[16]  Microsoft, \"How to investigate anomaly detection alerts,\" Microsoft, 8 June 2020. [Online]. Available: \nhttps://docs.microsoft.com/en -us/cloud -app-security/investigate -anomaly -alerts. [Accessed 11 Dec 2020].  \n[17]  Microsoft, \"Alert policies in the security and compliance center,\" Microsoft, 19 Nov 2020. [Online]. Available: \nhttps://docs.microsoft.com/en -us/microsoft -365/compliance/alert -policies?view=o365 -worldwide. [Accessed 11 Dec 2020].  \n[18]  Microsoft Security Response Center, \"Customer Guidance on Recent Nation -State Cyber Attacks,\" Microsoft, 13 Dec 2020. \n[Online]. Available: https://msrc -blog.microso ft.com/2020/12/13/customer -guidance -on-recent -nation -state -cyber -attacks/. \n[Accessed 14 Dec 2020].  \n[19]  N. Carr and shainw, \"Azure/Azure -Sentinel/Detections/AuditLogs/NewAppOrServicePrincipalCredential.yaml,\" 3 Dec 2020. \n[Online]. Available: https://gith ub.com/Azure/Azure -\nSentinel/blob/master/Detections/AuditLogs/NewAppOrServicePrincipalCredential.yaml. [Accessed 15 Dec 2020].  \n[20]  NSA, \"UPDATE AND UPGRADE SOFTWARE IMMEDIATELY,\" NSA, 30 Aug 2019. [Online]. Available: \nhttps://media.defense.gov/2019/Sep/0 9/2002180319/ -1/-\n1/0/UPDATE%20AND%20UPGRADE%20SOFTWARE%20IMMEDIATELY.PDF. [Accessed 9 Dec 2020].  \n\n \n \nU/OO/198854 -20 | PP-20-1485 | Dec 2020  Rev. 1.0 5 \nDetecting Federated Authentication Abuse  \nDisclaimer of Endorsem ent \nThe information and opinions contained in this document are provided \"as is\" and without any warranties or guarantees. Reference herein to any specific \ncommercial products, process, or service by trade name, trademark, manufacturer, or otherwise, does not constitute or imply i ts endorsement, \nrecommendation, or favoring by the United States Government, and this guidance sha ll not be used for advertising or product endorsement purposes.  \nPurpose  \nThis document was developed in furtherance of NSAs cybersecurity missions, including its responsibilities to identify and di sseminate threats to \nNational Security Systems, Department of Defense, and Defense Industrial Base information systems, and to develop and issue cybersecurity \nspecifications and mitigations. This information may be shared broadly to reach all appropriate stakeholders.  \nContact  \nClient Requirements / General Cybersecurity Inquiries: Cy bersecurity Requirements Center , 410 -854-4200,  Cybersecurity_Requests@nsa.gov   \nMedia inquiries / Press Desk: Media Relations, 443-634-0721, MediaRelations@nsa.gov   \n\n",
  "cves": [],
  "techniques": [
    "T1552",
    "T1114",
    "T1552.004",
    "T1114.002",
    "T1199"
  ],
  "advisory": "cybersecurity-alerts",
  "title": "authentication_mechanisms_csa_u_oo_198854_20",
  "source": "nsa",
  "id": "e560748945dd6ee990660bdf5ff134a797422b0fa7eb41553b46dbd815ebab7d"
}