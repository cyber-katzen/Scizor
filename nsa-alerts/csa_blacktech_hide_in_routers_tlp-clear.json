{
  "markdown": " \n  \n \nThis information is marked TLP:CLEAR. Recipients may share this information without restriction. Information is \nsubject to standard copyright rules. For more information on the Traffic Light Protocol, see cisa.gov/ tlp/. \n \nU/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 | Cybersecurity Advisory  \nTLP:CLEAR  \nTLP:CLEAR  People's Republic of China -Linked Cyber Actor s \nHide in  Router Firmware \nExecutive summary  \nThe United States National Security Agency (NSA), the U.S. Federal Bureau of \nInvestigation (FBI), the U.S. Cybersecurity and Infrastructure Security Agency (CISA), \nthe Japan National Police Agency (NPA) , and the Japan National Center of Incident \nReadiness and Strategy for Cybersecurity (NISC)  (hereafter r eferred to as the \nauthoring agencies) are releasing  this joint cybersecurity advisory (CSA) to detai l \nactivity of the Peoples Republic of China (PRC) -linked  cyber actor s known as \nBlackTech . BlackTech has demonstrated capabilities in  modifying router firmware  \nwithout detection  and exploit ing routers domain -trust relationships for pivot ing from \ninternational subsidiaries to headquarter s in Japan and the U.S.  the primary targets . \nThe authoring agencies recommend implementing the  mitigations  described to detect \nthis activity and protect  devices from the backdoors the  BlackTech actors are  leaving \nbehind. \nBlackTech (a.k.a. Palmerworm, Temp. Overboard, Circuit Panda, and Radio Panda)  \nactors have targeted  government, industrial, technology, media, electronics, and \ntelecommunication  sectors, including entities that support the militaries of the U.S. and \nJapan.  BlackTech actors  use custom malware, dual -use tools, and living off the land \ntactics , such as  disabling  logging on routers , to co nceal their operations . This CSA  \ndetails BlackTechs tactics, techniques, and procedures (TTPs) , which  highlight s the \nneed for m ultinational corporations to review all subsidiary connections , verify access , \nand consi der implement ing Zero Trust models  to limit the extent of a potential \nBlackTech compromise.  \nFor more information on the risks posed by this deep level of unauthorized access , see \nthe CSA  Peoples Republic of China State -Sponsored Cyber Actors Exploit Network \nProviders and Devices . [1] \n  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  2 Technical  details  \nThis advisory uses the  MITRE ATT&CK for Enterprise  framework , version 13 .1. See \nthe Appendix: MITRE ATT&CK Techniques  for all referenced TTPs .  \nBackground   \nActive since  2010, BlackTech actors have historically targeted a wide range  of U.S. and \nEast Asia public organizations and private industries. BlackTech actors TTPs include \ndeveloping  custom ized malware and  tailored persistence mechanisms  for compromising  \nrouters . These TTPs allow the actors to disable logging  [T1562]  and ab use trusted \ndomain relationships  [T1199]  to pivot between international subsidiaries  and domestic \nheadquarter s networks . \nObservable  TTPs \nBlackTech cyber actors use custom malware payloads and remote access tools (RATs)  \nto target victims operating systems . The actors have  used a range of custom malware \nfamilies targeting Windows, Linux, and FreeBSD operating systems . Custom \nmalware families employed by BlackTech include:  \n BendyBe ar [S0574]  \n Bifrose  \n BTSDoor  \n FakeDead (a.k.a. TSCookie) [S0436]  \n FlagPro [S0696]  \n FrontShell (FakeDeads downloader module)  \n IconDown  \n PLEAD [S0435]  \n SpiderPig  \n SpiderSpring  \n SpiderStack  \n WaterBear [S0579]  \nBlackTech  actors continuously update these tools to evade detection  [TA0005]  by \nsecurity software.  The actor s also use stolen code -signing certificates [T1588.003]  to \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  3 sign the malicious payloads, which ma ke the m appear legitimate and therefore more \ndifficult for security software to  detect [T1553.002 ]. \nBlackTech actors use living off the land TTPs t o blend in with normal operating system \nand network activities , allowing them to  evade detection  by endpoint detection and \nresponse (EDR) products . Common methods of persistence  on a host  includ e NetCat \nshells, modifying the victim registry  [T1112]  to enable the r emote desktop protocol  \n(RDP)  [T1021.001] , and secure shell ( SSH) [T1021.004] . The actors have also  used \nSNScan for enumeration  [TA0007] , and a local file transfer protocol  (FTP)  server  \n[T1071.002]  to move data through the victim network . For additional examples of \nmalicious cyber actors living off the land , see People's Republic of China State -\nSponsored Cyber Actor Living off the Land to Evade Detection . [2] \nPivoting from international subsidiaries  \nThe PRC -linked BlackTech actors target international subsidiaries of U.S. and \nJapanese companies. After gaining access [TA0001]  to the subsidiaries internal \nnetworks, BlackTech actors are able to pivot from the trusted internal routers to other \nsubsidiaries of the companies  and the headquarters networks.  BlackTech actors exploit \ntrusted network relationships between an established victim and other entities to expand \ntheir access  in target networks. \nSpecifically, u pon gaining an initial foothold into a target network  and gaining \nadministrator access to net work  edge  devices , BlackT ech cyber actors often modif y the \nfirmware to hide their activity across the edge devices  to further  maintain persistence in \nthe network. To extend their foothold across an organization, BlackTech actors target \nbranch routers typically smaller appliances  used at remote branch offices to connect \nto a corporate headquarters and then abuse the trusted  relationship [T1199 ] of the \nbranch routers with in the corporate network being targeted. BlackTech actors then use \nthe c ompromised public -facing branch routers as part of their infrastructure for proxying \ntraffic  [TA0011] , blending in w ith corporate network traffic, and pivoting to other victims \non the same corporate network  [T1090.002 ].  \nMaintaining access  via stealthy router backdoors  \nBlackTech has targeted and  exploited various  brands  and versions  of router devices.  \nTTPs against routers  enable  the actors to conceal configuration changes, hide \ncommands, and disable  logging while BlackTech  actors conduct operations . BlackTech  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  4 actors  have compromised several Cisco routers using variations  of a customized  \nfirmware backdoor [T1542.00 4]. The backdoor functionality is enabled and disabled \nthrough specially crafted TCP or UDP packets [T1205 ]. This TTP is not solely limited to \nCisco routers, and similar techniques could be used to enable backdoors in  other \nnetwork equipment. \nIn some cases, BlackTech  actors replace the firmware for  certain  Cisco IOS-based \nrouters with malicious firmware. Although BlackTech actors already had  elevated \nprivileges  [TA0004]  on the router to replace the firmware via comman d-line execution, \nthe malicious firmware is used to establish persistent backdoor access [TA0003]  and \nobfuscate future malicious activity . The modified firmware use s a built -in SSH backd oor \n[T1556.004 ], allowing BlackTech  actors  to maintain access to the  compromised  router \nwithout  BlackTech connections being logged  [T1562.003 ]. BlackTech actors  bypass the \nrouter's built-in security features by first installing older legitimate firmware [T1601.002 ] \nthat they then modify in memory  to allow  the installation of a modified , unsigned  \nbootloader and modified , unsigned  firmware [T1601.001 ]. The modified b ootloader \nenables the modified firmware to continue evad ing detec tion [T1553 .006], however, it is \nnot always necessary. \nBlackTech actors  may also  hide their presence and obfuscate changes made to \ncompromised Cisco routers by hiding Embedded Event Manager (EEM) policies a \nfeature usually used in Cisco IOS to automate tasks that execute upon specified \nevents that manipulate  Cisco IOS Command -Line In terface (CLI) command results.  \nOn a compromised router, the BlackTech -created EEM policy waits for  specific \ncommands  to execute obfuscation measures or den y execution of specified legitimate \ncommands. Th is policy has two functions: (1) to remove lines conta ining certain strings \nin the output of specified, legitimate Cisco IOS CLI commands  [T1562.006 ], and (2) \nprevent the execution of other legitimate CLI commands, such as  hinder ing forensic \nanalysis by blocking copy, rename, and move commands for the associated EEM policy  \n[T1562.001 ]. \nFirmware replacement process \nBlackTech  actors  utilize the following file types to compromise the router. These files \nare downloaded to the router via FTP  or SSH .  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  5 Table 1: File types to compromise the router  \nFile Type  Description  \nOld Legitimate \nFirmware  The IOS image firmware is modified in memory to allow installation \nof the Modified Firmware and Modified Bootloader.  \nModified \nFirmware  The firmware has a built -in SSH backdoor, allow ing operators to \nhave unlogged interaction with the router.  \nModified \nBootloader  The bootloader allows Modified Firmware to continue evading the \nrouter's security features  for persistence across reboots . In some \ncases, only modified firmware is used.  \nBlackTech actors use the Cisco router's CLI to replace the routers  IOS image  firmware.  \nThe process begins with the firmware being  modified in memory also called hot \npatching to allow  the installation of  a modified bootloader and modified firmware \ncapable of bypass ing the  router s security features . Then , a specifically constructed \npacket triggers  the router to enable the backdoor that bypass es logging  and the access \ncontrol list (ACL) . The steps are as follows:  \n1. Download old legitimate firmware . \n2. Set the router to load  the old  legitimate firmware and reboot with the following \ncommand(s):  \nconfig t  \nno boot system usbflash0 [filename]  \nboot system usbflash0 [filename]  \nend \nwrite \nreload \n3. Download  the modified boot loader and modified firmware . \n4. Set the router to load the modified firmware with the following command(s):  \nconf t \nno boot system usbflash0 [filename]  \nboot system usbflash0 [filename]  \nend \nwrite \n5. Load the modified bootloader  (the router reboot s automatically ) with the following \ncommand : \nupgrade rom file bootload er \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  6 6. Enable access  by sending a trigger packet that has specific values within the UDP \ndata or TCP Sequence Number field and the Maximum Segment Size ( MSS) \nparameter within the TCP Options field.  \nModified bootloader  \nTo allow the modified bootloader and firmware to be installed on Cisco IOS  without \ndetection , the cyber actors  install an old, legitimate firmware and then modify that \nrunning firmware in memory to bypass  firmware signature checks  in the  Cisco ROM \nMonitor (ROMMON) signature validation functions . The modified version s instructions \nallow the actor s to bypass functions of th e IOS Image Load test and the Field \nUpgradeable ROMMON In tegrity test.  \nModified firmware  \nBlack Tech actors  install modified IOS image firmware that allow s backdoor access via \nSSH to bypass  the routers  normal  logging functions. The firmware consists of a Cisco \nIOS loader that will load an embedded IOS image.  \nBlackTech actors  hook several functions in the embedded Cisco IOS image to jump to \ntheir own code. They  overwrite existing  code to handle magic packet  checking , \nimplement an SSH backdoor, and bypass logging functionality  on the compromised \nrouter . The modifi ed instructions bypass command logging, IP address ACLs, and error \nlogging.  \nTo enable the ba ckdoor functions, the firmware checks for incoming trigger packets and \nenables or disables the backdoor functionality. When the backdoor is enabled, \nassociated logging functions on the router are bypassed. The source IP address is \nstored and used  to bypass ACL  handling  for matching packets.  The SSH backdoor  \nincludes a special username  that does not require additional authentication.  \nDetection and mitigation techniques  \nIn order to detect and mitigate this BlackTech malicious activity, the  authoring agencies \nstrongly recommend the  following detection and mitigation techniques . It would be trivial \nfor the BlackTech actors to modify values  in their  backdoor s that would  render  specific \nsignatures of this router backdoor obsolete. For more robust detection, network \ndefenders should monitor network devices for unauthorized downloads of bootloaders \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  7 and firmware images  and reboots . Network defenders shou ld also m onitor for unusual \ntraffic destined to the router , including SSH.  \nThe following  are the best mitigation practices to defend against this type of malicious \nactivity:  \n Disable outbound connections by applying the \"transport output none\" \nconfiguration command to the virtual teletype ( VTY) lines. This command will \nprevent some copy commands from successfully connectin g to external systems. \nNote:  An adversary with unauthori zed privileged level access to a network \ndevice could revert this configuration change.  [3] \n Monitor both inbound and outbound connections from network devices to b oth \nexternal and internal systems. In general, network devices should only be \nconnecting to nearby devices for exchanging routing or network topology \ninformation or with administrative systems for time synchronization, logging, \nauthentication, monitoring, etc. If feasible, block unauthorized outbound \nconnections from network devices by applying access lists or rule sets to other \nnearby network devices. Additionally, place administrative systems in separate \nvirtual local area networks ( VLANs ) and block all u nauthorized traffic from \nnetwork devices destined for non -administrative VLANs.  [4] \n Limit access to administration services and only permit IP addresses used by \nnetwork administrators by applying access lists to the VTY lines or specific \nservices. Monitor logs for successful and unsuccessful login attempts with the \n\"login on -failure log\" and \"login on -success log\" configuration commands, or by \nreviewing centralized Authentication, Authorization, and Accounting (AAA) \nevents.  [3] \n Upgrade devices to ones that have secure boot capabilities with better integrity \nand authenticity c hecks for bootloaders and firmware. In particular, highly \nprioritize replacing all end -of-life and unsupported equipment as soon as \npossible.  [3] [5] \n When  there is a concern that a single password has been compromised , change \nall passwords and keys . [3] \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  8  Review logs generated by network devices and monitor for unauthorized reboots, \noperating system version changes, changes to the configuration , or attempts to \nupdate the firmware . Compare agai nst expected configuration changes and \npatching plans to verify that the changes are authorized. [3] \n Periodically perform both file and memory verification describe d in the Network \nDevice Integrity (NDI) Methodology documents to detect unauthorized changes \nto the software stored and running on network devices.  [3] \n Monitor for  changes to firmware. Periodically take snapshots of boot records and \nfirmware and compare against known good images. [3] \n  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  9 Works cited  \n[1] Joint CSA, Peoples Republi c of China State -Sponsored Cyber Actors Exploit Network Providers and \nDevices, https://media.defense.gov/ 2022/Jun/07/2003013376/ -1/-\n1/0/CSA_PRC_SPONSORED_CYBER_ACTORS_EXPLOIT_NETWORK_PROVIDERS_DEVICES_TLPWH\nITE.PDF   \n[2] Joint CSA, People's Republic of China State -Sponsored Cyber Actor Living off the Land to Evade Detection, \nhttps://media.defense.gov/2023/May/24/2003229517/ -1/-\n1/0/CSA_PRC_State_Sponsored_Cyber_Living_off_the_Land_v1.1.PDF   \n[3] NSA, Network Infrastructure Security Guide, https://media.defense.gov/2022/Jun/15/2003018261/ -1/-\n1/0/CTR_NSA_NETWORK_INFRASTRUCTURE_SECURITY_GUIDE_20220615.PDF   \n[4] NSA, Perfo rming Out -of-Band Network Management, https://media.defense.gov/2020/Sep/17/2002499616/ -\n1/-1/0/PERFORMING_OUT_OF_BAND_NETWORK_MANAGEMENT20200911.PDF   \n[5] Cisco, Attackers Continue to Target Legacy Devices, https://community.cisco.com/t5/security -\nblogs/attackers -continue -to-target -legacy -devices/ba -p/4169954   \nDisclaimer of endorsement  \nThe information and opinions contained in this document are provided \"as is\" and without any warran ties or \nguarantees. Reference herein to any specific commercial products, process, or service by trade name, trademark, \nmanufacturer, or otherwise, does not constitute or imply its endorsement, recommendation, or favoring by the United \nStates Government  or Japan , and this guidance shall not be used for advertising or product endorsement purposes.  \nTrademark recognition  \nCisco and Cisco IOS are registered trademarks of Cisco Technology, Inc.  \nFreeBSD is a registered trademark of The FreeBSD Foundation.  \nLinux is  a registered trademark of Linus Torvalds.  \nMITRE and MITRE ATT&CK are registered trademarks of The MITRE Corporation.  \nWindows is a registered trademark of Microsoft Corporation.  \nPurpose  \nThis document was developed in furtherance of the authoring agencies cybersecurity missions, i ncluding their  \nresponsibilities to iden tify and disseminate cyber threats, and to develop and issue cybersecurity specifications and \nmitigations.  \nContact  \nNSA Cybersecurity Report Questions and Feedback: CybersecurityReports@nsa.gov   \nNSAs Defense Industrial Base Inquiries and Cybersecurity Services: DIB_Defense@cyber.nsa.gov   \nNSA Media Inquiries / Press Desk : 443 -634-0721, MediaRelations@nsa.gov  \n \nU.S. organizations : Report incidents and anomalous activity to CISA 24/7 Operations Center at \nReport@cisa.dhs.gov , cisa.gov/report , or (888) 282 -0870 and/or to the FBI via your local FBI field office . \n  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  10 Appendix : MITRE ATT&CK Te chniques   \nSee Tables 1 -8 for all referenced BlackTech tactics and techniques in this advisory.  \nTable 1: BlackTech ATT&CK Techniques for Enterprise  Resource Development  \nTechnique Title  ID Use \nObtain Capabilities: Code \nSigning Certificates  T1588.003  BlackTech actors use stolen code -signing \ncertificates to sign payloads and evade de fenses.  \n \nTable 2: BlackTech ATT&CK Techniques for Enterprise  Initial Access  \nTechnique Title ID Use \nInitial Access  TA0001  BlackTech actors gain access to victim networks by \nexploiting routers.  \nTrusted Relationship  T1199  BlackTech actors exploit trusted domain \nrelationships of routers to gain access to victim \nnetworks.  \n \nTable 3: BlackTech ATT&CK Techniques for Enterprise  Persistence  \nTechnique Ti tle ID Use \nPersistence  TA0003  BlackTech actors gain persistent access to victims \nnetworks.  \nTraffic Signaling  T1205  BlackTech actors send specially crafted packets to \nenable or disable backdoor functionality on a \ncompromised router.  \nPre-OS Boot: ROMMONkit  T1542.00 4 BlackTech actors modify  router firmware to \nmaintain persistence.  \n \n  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  11  \nTable 4: BlackTech ATT&CK Techniques for Enterprise  Privilege Escalation  \nTechnique Title  ID Use \nPrivilege Escalation  TA0004  BlackTech  actors gain elevated privileges on a \nvictims network.  \n \nTable 5: BlackTech ATT&CK Techniques for Enterprise  Defense Evasion  \nTechnique Title  ID Use \nDefense Evasion  TA0005  BlackTech  actors configure their tools to evade \ndetection by security software and EDR.  \nModify Registry  T1112  BlackTech actors modify the victims registry.  \nImpair Defenses  T1562  BlackTech actors disable logging on compromised \nrouters to avoid detection and evade defenses.  \nImpair Defenses: Impair \nCommand History Logging  T1562.003  BlackTech actors disable logging on the \ncompromised routers to prevent logging of any \ncommands issued.  \nModify System Image: \nPatch System Image  T1601.001  BlackTech actors modify router firmware to evade \ndetection.  \n \nTable 6: BlackTech ATT&CK Techniques for Enterprise  Discovery  \nTechnique Title  ID Use \nDiscovery  TA0007  BlackTech actors use SNScan to enumerate \nvictims networks and obtain further network \ninformation.  \n \nTable 7: BlackTech ATT&CK Techniques for Enterprise  Lateral Movement  \nTechnique  Title ID Use \nRemote Services: Remote \nDesktop Protocol  T1021.001  BlackTech actors use RDP to move laterally across \na victims network.  \n\n  \n U/OO/ 205179 -23 | PP-23-3215  | SEP 2023  Ver. 1.0 Joint CSA | PRC -Linked Cyber Actors Hide in Router Firmware  \nTLP:CLEAR  \nTLP:CLEAR  12 Remote Services: SSH  T1021.004  BlackTech actors use SSH to move laterally across \na victims network.  \n \nTable 8: BlackTech ATT&CK Techniques for Enterprise  Command and Control  \nTechnique Title  ID Use \nCommand and Control  TA0011  BlackTech actors compromise and control a \nvictims network infrastructure.  \nApplication Layer Protocol: \nFile Transfer Protocols  T1071.002  BlackTech actors use FTP to move data through a \nvictims network or to deliver scripts for \ncompromising routers.  \nProxy  T1090  BlackTech actors use compromised routers to \nproxy traffic.  \n \n\n",
  "cves": [],
  "techniques": [
    "T1021.001",
    "T1601.002",
    "T1562.001",
    "T1588.003",
    "T1556.004",
    "T1090.002",
    "T1562.003",
    "T1601.001",
    "T1071.002",
    "T1021.004",
    "T1553.002",
    "T1562.006"
  ],
  "advisory": "cybersecurity-alerts",
  "title": "csa_blacktech_hide_in_routers_tlp-clear",
  "source": "nsa",
  "id": "88e8bd612d8b5aa1b20ecccceecea5aadb02a378bb471c4444b75f6c2cf76cf1"
}